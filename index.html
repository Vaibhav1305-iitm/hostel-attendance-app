<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hostel Attendance System</title>

    <!-- PWA Features (disabled for local testing) -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    <link rel="apple-touch-icon" href="hostel_app_icon.png">
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Google+Sans:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <style>
        :root {
            /* Apple iOS Light Theme Colors */
            --md-sys-color-primary: #007AFF;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #007AFF;
            --md-sys-color-on-primary-container: #ffffff;
            --md-sys-color-secondary: #8E8E93;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #E5E5EA;
            --md-sys-color-on-secondary-container: #1C1C1E;
            --md-sys-color-tertiary: #5856D6;
            --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-tertiary-container: #E8E8F0;
            --md-sys-color-on-tertiary-container: #1C1C1E;
            --md-sys-color-error: #FF3B30;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-background: #F2F2F7;
            --md-sys-color-on-background: #1C1C1E;
            --md-sys-color-surface: #FFFFFF;
            --md-sys-color-on-surface: #1C1C1E;
            --md-sys-color-surface-variant: #E5E5EA;
            --md-sys-color-on-surface-variant: #8E8E93;
            --md-sys-color-outline: #C6C6C8;

            /* Apple Status Colors */
            --color-present: #34C759;
            --color-present-container: #E3F9E8;
            --color-absent: #FF3B30;
            --color-absent-container: #FFE5E3;
            --color-leave: #FF9500;
            --color-leave-container: #FFF4E5;

            --drawer-width: 300px;
            --top-bar-height: 64px;
        }

        [data-theme="dark"] {
            /* Apple iOS Dark Theme Colors */
            --md-sys-color-primary: #0A84FF;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #0A84FF;
            --md-sys-color-on-primary-container: #ffffff;
            --md-sys-color-secondary: #8E8E93;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #3A3A3C;
            --md-sys-color-on-secondary-container: #E5E5EA;
            --md-sys-color-tertiary: #5E5CE6;
            --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-tertiary-container: #2C2C2E;
            --md-sys-color-on-tertiary-container: #E5E5EA;
            --md-sys-color-error: #FF453A;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-background: #000000;
            --md-sys-color-on-background: #FFFFFF;
            --md-sys-color-surface: #1C1C1E;
            --md-sys-color-on-surface: #FFFFFF;
            --md-sys-color-surface-variant: #2C2C2E;
            --md-sys-color-on-surface-variant: #8E8E93;
            --md-sys-color-outline: #48484A;

            /* Apple Status Colors Dark */
            --color-present: #30D158;
            --color-present-container: #1A3D24;
            --color-absent: #FF453A;
            --color-absent-container: #3D1A18;
            --color-leave: #FF9F0A;
            --color-leave-container: #3D2E0A;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: 17px;
            overflow-x: hidden;
            padding-bottom: 100px;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Layout --- */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* --- Navigation Drawer --- */
        .drawer-scrim {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .drawer-scrim.open {
            opacity: 1;
            pointer-events: auto;
        }

        .nav-drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--drawer-width);
            height: 100%;
            height: 100dvh;
            /* Dynamic viewport height for mobile */
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            z-index: 1300;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            display: flex;
            flex-direction: column;
            border-top-right-radius: 16px;
            border-bottom-right-radius: 16px;
            overflow: hidden;
        }

        .nav-drawer.open {
            transform: translateX(0);
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.15);
        }

        /* Lock body scroll when drawer is open */
        body.drawer-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        .drawer-header {
            padding: 24px 16px 12px;
            font-family: 'Google Sans', sans-serif;
            font-size: 22px;
            font-weight: 500;
            color: var(--md-sys-color-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .drawer-content {
            padding: 12px;
            flex: 1;
            overflow-y: auto;
        }

        .drawer-item {
            display: flex;
            align-items: center;
            height: 56px;
            padding: 0 16px 0 24px;
            border-radius: 28px;
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .drawer-item:hover {
            background-color: rgba(var(--md-sys-color-on-surface-variant), 0.08);
            /* Computed color logic approximation */
            background-color: #efefef;
            /* Fallback */
        }

        .drawer-item.active {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .drawer-item .material-symbols-outlined {
            margin-right: 12px;
            font-size: 24px;
            font-variation-settings: 'FILL' 0;
        }

        .drawer-item.active .material-symbols-outlined {
            font-variation-settings: 'FILL' 1;
        }

        .drawer-divider {
            height: 1px;
            background-color: var(--md-sys-color-outline);
            margin: 8px 16px;
            opacity: 0.2;
        }

        .drawer-label {
            padding: 16px 24px 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
        }

        /* --- Main Content --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        /* --- Top App Bar (Search Pill Style) --- */
        .top-app-bar-container {
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 12px 16px 20px 16px;
            background-color: var(--md-sys-color-background);
        }

        .search-pill {
            display: flex;
            align-items: center;
            height: 36px;
            background-color: var(--md-sys-color-surface-variant);
            border-radius: 10px;
            padding: 0 12px;
            box-shadow: none;
            transition: background-color 0.2s;
        }

        .search-pill.elevated {
            background-color: var(--md-sys-color-surface-variant);
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant);
        }

        .icon-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* User Avatar in Search Pill */
        .user-avatar-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            margin-right: 4px;
            overflow: hidden;
            border: none;
        }

        .search-content {
            flex: 1;
            margin: 0 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .app-title {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--md-sys-color-on-surface);
            line-height: 1.2;
            letter-spacing: -0.5px;
        }

        .subtitle {
            font-size: 13px;
            color: var(--md-sys-color-on-surface-variant);
            line-height: normal;
            margin-top: 2px;
        }

        /* --- Action Area (Date, Verify) --- */
        .action-area {
            padding: 8px 16px 16px;
        }

        .control-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }

        .date-input-container {
            flex: 1;
            position: relative;
        }

        .date-input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border-radius: 8px;
            border: 1px solid var(--md-sys-color-outline);
            background: transparent;
            color: var(--md-sys-color-on-surface);
            font-family: inherit;
            font-size: 14px;
        }

        .date-input-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--md-sys-color-on-surface-variant);
            pointer-events: none;
        }

        .verification-card {
            background-color: var(--md-sys-color-tertiary-container);
            color: var(--md-sys-color-on-tertiary-container);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .verification-card.verified {
            background-color: var(--color-present-container);
            color: #00210e;
            border: 1px solid var(--color-present);
        }

        .verification-label {
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- Student List --- */
        .student-list-container {
            padding: 0 16px 100px;
            /* Bottom padding for FAB */
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .list-header {
            font-size: 14px;
            color: var(--md-sys-color-primary);
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-card {
            display: flex;
            align-items: center;
            background-color: var(--md-sys-color-surface);
            padding: 12px 16px;
            border-radius: 12px;
            border: none;
            border-bottom: 1px solid var(--md-sys-color-outline);
            margin-bottom: 1px;
        }

        .student-card:first-child {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .student-card:last-child {
            border-bottom: none;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .student-avatar {
            width: 44px;
            height: 44px;
            border-radius: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 17px;
            font-weight: 600;
            margin-right: 12px;
            flex-shrink: 0;
            background-color: var(--md-sys-color-primary);
            color: white;
        }

        .student-info {
            flex: 1;
            min-width: 0;
        }

        .student-name {
            font-size: 17px;
            font-weight: 400;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 2px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.25;
            word-break: break-word;
        }

        .student-id {
            font-size: 13px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .status-actions {
            display: flex;
            gap: 6px;
        }

        .status-chip {
            width: 34px;
            height: 34px;
            border-radius: 17px;
            border: 2px solid var(--md-sys-color-outline);
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant);
            transition: all 0.15s ease;
        }

        .status-chip.active {
            color: white;
            border: none;
            transform: scale(1.05);
        }

        .status-chip.status-P.active {
            background-color: var(--color-present);
            box-shadow: 0 2px 8px rgba(52, 199, 89, 0.4);
        }

        .status-chip.status-A.active {
            background-color: var(--color-absent);
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.4);
        }

        .status-chip.status-L.active {
            background-color: var(--color-leave);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 149, 0, 0.4);
        }

        /* --- iOS Style Action Buttons --- */
        .fab {
            height: 50px;
            border-radius: 25px;
            background-color: var(--md-sys-color-primary);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 24px;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            font-size: 17px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
            gap: 8px;
        }

        .fab:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        .fab.small {
            height: 44px;
            padding: 0;
            width: 44px;
            justify-content: center;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-primary);
            border-radius: 22px;
            border: 1px solid var(--md-sys-color-outline);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .fab-icon {
            font-size: 20px;
        }

        .fab-container {
            position: fixed;
            bottom: 34px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: row;
            gap: 12px;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }

        /* --- iOS-Style Toast Notifications --- */
        .ios-toast-container {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            pointer-events: none;
        }

        .ios-toast {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 13px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
            font-size: 15px;
            font-weight: 500;
            color: #1C1C1E;
            min-width: 200px;
            max-width: 340px;
            animation: iosToastIn 0.35s cubic-bezier(0.32, 0.72, 0, 1);
            pointer-events: auto;
        }

        [data-theme="dark"] .ios-toast {
            background: rgba(44, 44, 46, 0.95);
            color: #FFFFFF;
        }

        .ios-toast.hiding {
            animation: iosToastOut 0.25s cubic-bezier(0.32, 0, 0.67, 0) forwards;
        }

        .ios-toast-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .ios-toast-icon .material-symbols-outlined {
            font-size: 18px;
            font-variation-settings: 'FILL' 1;
        }

        .ios-toast.success .ios-toast-icon {
            background: #34C759;
            color: white;
        }

        .ios-toast.error .ios-toast-icon {
            background: #FF3B30;
            color: white;
        }

        .ios-toast.info .ios-toast-icon {
            background: #007AFF;
            color: white;
        }

        .ios-toast.warning .ios-toast-icon {
            background: #FF9500;
            color: white;
        }

        @keyframes iosToastIn {
            0% {
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes iosToastOut {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
        }

        /* --- iOS-Style Loading Overlay --- */
        .ios-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: iosOverlayIn 0.2s ease;
        }

        .ios-loading-overlay.hiding {
            animation: iosOverlayOut 0.2s ease forwards;
        }

        .ios-loading-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        [data-theme="dark"] .ios-loading-box {
            background: rgba(44, 44, 46, 0.95);
        }

        .ios-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 122, 255, 0.2);
            border-top-color: #007AFF;
            border-radius: 50%;
            animation: iosSpinner 0.8s linear infinite;
        }

        .ios-loading-text {
            font-size: 15px;
            font-weight: 500;
            color: #1C1C1E;
        }

        [data-theme="dark"] .ios-loading-text {
            color: #FFFFFF;
        }

        @keyframes iosSpinner {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes iosOverlayIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes iosOverlayOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /* Sync Status Badge */
        .sync-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .sync-badge.synced {
            background: rgba(52, 199, 89, 0.15);
            color: #34C759;
        }

        .sync-badge.not-synced {
            background: rgba(142, 142, 147, 0.15);
            color: #8E8E93;
        }

        /* Switch Toggle */
        .switch {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Desktop specific tweaks */
        @media (min-width: 600px) {
            .app-container {
                max-width: 600px;
                margin: 0 auto;
                background: var(--md-sys-color-surface);
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            }

            .drawer-scrim {
                display: none;
                /* In Gmail desktop, drawer pushes content. Here we keep it mobile style centered */
            }

            .nav-drawer {
                position: absolute;
                /* Relative to app container if we wanted, but fixed is easier overlay for now */
            }

            .fab-container {
                position: fixed;
                right: calc(50% - 276px);
                /* Center 600px / 2 = 300 - 24px margin */
                bottom: 24px;
            }
        }

        /* Stats Chips */
        .stats-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .stat-chip {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .stat-chip strong {
            font-size: 14px;
        }

        /* Admin Tabs and Tracking */
        .admin-tabs {
            display: flex;
            gap: 8px;
            padding: 0 16px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .admin-tab {
            background: none;
            border: none;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .admin-tab.active {
            color: var(--md-sys-color-primary);
            border-bottom-color: var(--md-sys-color-primary);
        }

        .tracking-table-container {
            overflow-x: auto;
            background: var(--md-sys-color-surface);
            border-radius: 12px;
            border: 1px solid var(--md-sys-color-outline-variant);
            margin-top: 12px;
        }

        .tracking-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 600px;
        }

        .tracking-table th,
        .tracking-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .tracking-table th {
            background: var(--md-sys-color-surface-variant);
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
        }

        .tracking-search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge.present {
            background: var(--color-present-container);
            color: #006020;
        }

        .badge.absent {
            background: var(--color-absent-container);
            color: var(--color-absent);
        }

        .badge.leave {
            background: var(--color-leave-container);
            color: #805600;
        }

        /* ADMIN PANEL v6.0 STYLES */
        .admin-header {
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            padding: 20px 16px;
            color: white;
            border-radius: 0 0 24px 24px;
            margin-bottom: 16px;
        }

        .admin-header-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .admin-header-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .admin-tabs-new {
            display: flex;
            gap: 4px;
            padding: 0 12px;
            margin-bottom: 16px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .admin-tabs-new::-webkit-scrollbar {
            display: none;
        }

        .admin-tab-new {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 16px;
            border-radius: 16px;
            border: none;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface-variant);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 70px;
            gap: 4px;
        }

        .admin-tab-new .material-symbols-outlined {
            font-size: 24px;
        }

        .admin-tab-new.active {
            background: var(--md-sys-color-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .admin-section {
            padding: 0 16px;
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .stats-cards-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: var(--md-sys-color-surface);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--md-sys-color-outline);
        }

        .stat-card-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--md-sys-color-primary);
        }

        .stat-card-label {
            font-size: 13px;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 4px;
        }

        .ranking-card {
            background: var(--md-sys-color-surface);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--md-sys-color-outline);
        }

        .ranking-position {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
        }

        .ranking-position.gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #fff;
        }

        .ranking-position.silver {
            background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
            color: #fff;
        }

        .ranking-position.bronze {
            background: linear-gradient(135deg, #CD7F32, #B87333);
            color: #fff;
        }

        .ranking-position.normal {
            background: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
        }

        .ranking-info {
            flex: 1;
            min-width: 0;
        }

        .ranking-name {
            font-size: 16px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ranking-category {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .ranking-score {
            text-align: right;
        }

        .ranking-score-value {
            font-size: 20px;
            font-weight: 700;
        }

        .ranking-score-label {
            font-size: 11px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .score-excellent {
            color: #34C759;
        }

        .score-good {
            color: #007AFF;
        }

        .score-warning {
            color: #FF9500;
        }

        .score-danger {
            color: #FF3B30;
        }

        .progress-bar {
            height: 6px;
            background: var(--md-sys-color-surface-variant);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .ai-card {
            background: var(--md-sys-color-surface);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid;
        }

        .ai-card.critical {
            border-left-color: #FF3B30;
            background: linear-gradient(90deg, rgba(255, 59, 48, 0.08) 0%, var(--md-sys-color-surface) 100%);
        }

        .ai-card.warning {
            border-left-color: #FF9500;
            background: linear-gradient(90deg, rgba(255, 149, 0, 0.08) 0%, var(--md-sys-color-surface) 100%);
        }

        .ai-card.info {
            border-left-color: #007AFF;
            background: linear-gradient(90deg, rgba(0, 122, 255, 0.08) 0%, var(--md-sys-color-surface) 100%);
        }

        .ai-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .ai-card-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-card.critical .ai-card-icon {
            background: rgba(255, 59, 48, 0.15);
            color: #FF3B30;
        }

        .ai-card.warning .ai-card-icon {
            background: rgba(255, 149, 0, 0.15);
            color: #FF9500;
        }

        .ai-card.info .ai-card-icon {
            background: rgba(0, 122, 255, 0.15);
            color: #007AFF;
        }

        .ai-card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .ai-card-students {
            font-size: 13px;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .ai-card-suggestion {
            font-size: 13px;
            color: var(--md-sys-color-on-surface);
            padding: 8px 12px;
            background: var(--md-sys-color-surface-variant);
            border-radius: 8px;
        }

        .medal-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .medal-badge.gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #fff;
        }

        .medal-badge.silver {
            background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
            color: #fff;
        }

        .medal-badge.bronze {
            background: linear-gradient(135deg, #CD7F32, #B87333);
            color: #fff;
        }

        .medal-badge.at-risk {
            background: rgba(255, 59, 48, 0.15);
            color: #FF3B30;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .empty-state .material-symbols-outlined {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .filter-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .filter-pill {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--md-sys-color-outline);
            background: var(--md-sys-color-surface);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .filter-pill.active {
            background: var(--md-sys-color-primary);
            color: white;
            border-color: var(--md-sys-color-primary);
        }

        /* --- Sync Tracker Styles --- */
        .sync-tracker-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--md-sys-color-background);
            z-index: 3000;
            display: none;
            flex-direction: column;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .sync-tracker-modal.hiding {
            animation: slideOutRight 0.25s ease forwards;
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
            }

            to {
                transform: translateX(100%);
            }
        }

        .sync-tracker-header {
            display: flex;
            align-items: center;
            padding: 16px;
            gap: 12px;
            background: var(--md-sys-color-surface);
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .sync-tracker-header h2 {
            flex: 1;
            font-size: 17px;
            font-weight: 600;
            margin: 0;
        }

        .sync-tracker-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .sync-tracker-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--md-sys-color-surface);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .sync-tracker-table th {
            background: var(--md-sys-color-surface-variant);
            padding: 12px 6px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            color: var(--md-sys-color-on-surface-variant);
        }

        .sync-tracker-table th:first-child {
            text-align: left;
            padding-left: 12px;
        }

        .sync-tracker-table td {
            padding: 14px 6px;
            text-align: center;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            font-size: 13px;
        }

        .sync-tracker-table td:first-child {
            text-align: left;
            padding-left: 12px;
            font-weight: 500;
        }

        .sync-tracker-table tr:last-child td {
            border-bottom: none;
        }

        .sync-tracker-table tr.today {
            background: rgba(0, 122, 255, 0.05);
        }

        .status-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .status-dot.synced {
            background: rgba(52, 199, 89, 0.15);
            color: #34C759;
        }

        .status-dot.not-synced {
            background: rgba(142, 142, 147, 0.1);
            color: #8E8E93;
        }

        .status-dot.complete {
            background: #34C759;
            color: white;
        }

        .sync-summary-card {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.1) 0%, rgba(88, 86, 214, 0.1) 100%);
            border-radius: 16px;
            padding: 20px;
            margin-top: 16px;
        }

        .sync-summary-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-progress-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .sync-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #34C759, #30D158);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .sync-summary-stats {
            font-size: 15px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .date-range-pills {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .date-range-pill {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--md-sys-color-outline);
            background: var(--md-sys-color-surface);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-range-pill.active {
            background: var(--md-sys-color-primary);
            color: white;
            border-color: var(--md-sys-color-primary);
        }
    </style>
</head>

<body>

    <!-- Navigation Drawer -->
    <div class="drawer-scrim" id="drawerScrim" onclick="closeDrawer()"></div>
    <nav class="nav-drawer" id="navDrawer">
        <div class="drawer-header">
            <span class="material-symbols-outlined">school</span>
            Attendance
        </div>

        <div class="drawer-content">
            <div class="drawer-label">Shifts</div>

            <a class="drawer-item active" onclick="switchCategory('Yoga')" id="nav-Yoga">
                <span class="material-symbols-outlined">self_improvement</span>
                Yoga
                <span id="nav-indicator-Yoga" style="margin-left: auto; font-size: 18px;"></span>
            </a>
            <a class="drawer-item" onclick="switchCategory('Mess Day')" id="nav-Mess Day">
                <span class="material-symbols-outlined">restaurant</span>
                Mess Day
                <span id="nav-indicator-Mess Day" style="margin-left: auto; font-size: 18px;"></span>
            </a>
            <a class="drawer-item" onclick="switchCategory('Mess Night')" id="nav-Mess Night">
                <span class="material-symbols-outlined">bedtime</span>
                Mess Night
                <span id="nav-indicator-Mess Night" style="margin-left: auto; font-size: 18px;"></span>
            </a>
            <a class="drawer-item" onclick="switchCategory('Night Shift')" id="nav-Night Shift">
                <span class="material-symbols-outlined">nights_stay</span>
                Night Shift
                <span id="nav-indicator-Night Shift" style="margin-left: auto; font-size: 18px;"></span>
            </a>

            <div class="drawer-divider"></div>
            <div class="drawer-label">Actions</div>

            <a class="drawer-item" onclick="openAddStudentModal()" style="color: var(--md-sys-color-primary);">
                <span class="material-symbols-outlined">person_add</span>
                Add Student
            </a>
            <a class="drawer-item" onclick="resetAttendance()">
                <span class="material-symbols-outlined">restart_alt</span>
                Reset Current
            </a>
            <a class="drawer-item" onclick="downloadAttendance()">
                <span class="material-symbols-outlined">download</span>
                Download CSV
            </a>
            <a class="drawer-item" onclick="downloadOverallAttendance()">
                <span class="material-symbols-outlined">table_view</span>
                Download Excel
            </a>

            <a class="drawer-item" onclick="openAdminLogin()">
                <span class="material-symbols-outlined">admin_panel_settings</span>
                Admin Panel
            </a>
            <a class="drawer-item" onclick="openSyncTracker()" style="color: var(--md-sys-color-tertiary);">
                <span class="material-symbols-outlined">analytics</span>
                Sync Tracker
            </a>

            <div class="drawer-divider"></div>
            <div class="drawer-label">Settings</div>

            <a class="drawer-item" onclick="toggleTheme()">
                <span class="material-symbols-outlined" id="themeIcon">dark_mode</span>
                <span id="themeText">Dark Mode</span>
            </a>
        </div>
    </nav>

    <div class="app-container">
        <div class="main-content">
            <!-- iOS Style Header -->
            <div class="top-app-bar-container">
                <!-- Large Title Row -->
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <button class="icon-btn" onclick="openDrawer()" style="margin-left: -8px;">
                            <span class="material-symbols-outlined">menu</span>
                        </button>
                        <div>
                            <div class="app-title" id="headerTitle">Yoga</div>
                            <div class="subtitle" id="headerDate">Select Date</div>
                        </div>
                    </div>
                    <button class="user-avatar-btn" onclick="toggleTheme()" title="Toggle Theme">
                        <span id="userInitial">A</span>
                    </button>
                </div>
                <!-- iOS Search Bar -->
                <div class="search-pill" id="searchPill" style="margin-bottom: 16px;">
                    <span class="material-symbols-outlined"
                        style="color: var(--md-sys-color-on-surface-variant); font-size: 20px;">search</span>
                    <input type="text" id="studentSearch" placeholder="Search student..."
                        style="flex: 1; border: none; background: transparent; outline: none; font-size: 17px; color: var(--md-sys-color-on-surface); font-family: inherit; margin-left: 8px;">
                </div>
            </div>

            <!-- Action Area -->
            <div class="action-area" style="padding-top: 16px; margin-top: 8px;">
                <!-- Date Selection - iOS Style -->
                <div class="control-row">
                    <div class="date-input-container"
                        style="background: var(--md-sys-color-surface); border-radius: 10px; padding: 12px 16px; display: flex; align-items: center; gap: 10px; border: 1px solid var(--md-sys-color-outline);">
                        <span class="material-symbols-outlined"
                            style="color: var(--md-sys-color-primary);">calendar_today</span>
                        <input type="date" id="attendanceDate"
                            style="border: none; background: transparent; font-size: 17px; color: var(--md-sys-color-on-surface); font-family: inherit; flex: 1; outline: none;">
                    </div>
                </div>

                <!-- Verification Card - iOS Style -->
                <div class="verification-card" id="verificationCard" onclick="toggleVerification()"
                    style="background: var(--md-sys-color-surface); border: 1px solid var(--md-sys-color-outline);">
                    <div class="verification-label">
                        <span class="material-symbols-outlined" id="verifyIcon">check_circle_outline</span>
                        <span id="verifyText">Mark as Verified</span>
                    </div>
                    <div class="switch">
                        <span class="material-symbols-outlined" id="verifyCheckmark"
                            style="opacity: 0; color: var(--color-present);">done</span>
                    </div>
                </div>

                <!-- Fetch from Database Button (only visible for past dates) -->
                <div id="fetchButtonContainer" style="display: none; margin-bottom: 12px;">
                    <button onclick="fetchCurrentSectionFromDB()" style="width: 100%; padding: 14px 16px; border-radius: 12px; border: 1px solid var(--md-sys-color-primary); 
                        background: linear-gradient(135deg, rgba(0,122,255,0.08) 0%, rgba(88,86,214,0.08) 100%); 
                        color: var(--md-sys-color-primary); font-size: 15px; font-weight: 600; 
                        display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;
                        font-family: inherit;">
                        <span class="material-symbols-outlined" style="font-size: 20px;">cloud_download</span>
                        Fetch <span id="fetchCategoryName">Yoga</span> from Database
                    </button>
                    <div id="fetchStatusText"
                        style="text-align: center; font-size: 12px; color: var(--md-sys-color-on-surface-variant); margin-top: 6px;">
                    </div>
                </div>

                <!-- Stats - iOS Segmented Style -->
                <div class="stats-row"
                    style="background: var(--md-sys-color-surface); border-radius: 10px; padding: 8px; display: flex; gap: 4px; border: 1px solid var(--md-sys-color-outline);">
                    <div class="stat-chip"
                        style="flex: 1; justify-content: center; background: var(--color-present-container); color: var(--color-present); border-radius: 8px; padding: 8px;">
                        <span style="font-weight: 400;">Present</span>
                        <strong id="presentCount">0</strong>
                    </div>
                    <div class="stat-chip"
                        style="flex: 1; justify-content: center; background: var(--color-absent-container); color: var(--color-absent); border-radius: 8px; padding: 8px;">
                        <span style="font-weight: 400;">Absent</span>
                        <strong id="absentCount">0</strong>
                    </div>
                    <div class="stat-chip"
                        style="flex: 1; justify-content: center; background: var(--color-leave-container); color: #B86E00; border-radius: 8px; padding: 8px;">
                        <span style="font-weight: 400;">Leave</span>
                        <strong id="leaveCount">0</strong>
                    </div>
                </div>

                <div class="list-header" style="margin-top: 16px; color: var(--md-sys-color-on-surface-variant);">
                    <span style="text-transform: uppercase; font-size: 13px; letter-spacing: 0.5px;">Students</span>
                    <span id="totalStudentsCount" style="font-size: 13px;">0 total</span>
                </div>
            </div>

            <!-- Student List -->
            <div id="studentList" class="student-list-container">
                <div class="student-card" style="justify-content: center; color: var(--md-sys-color-outline);">
                    No data loaded. Upload CSV to begin.
                </div>
            </div>

        </div>
    </div>

    <!-- FABs -->
    <div class="fab-container">
        <button class="fab small" onclick="syncCurrentSection()" aria-label="Sync Section" title="Sync Current Section">
            <span class="material-symbols-outlined fab-icon">cloud_upload</span>
        </button>

        <button class="fab" onclick="syncToGoogleSheet()">
            <span class="material-symbols-outlined fab-icon">cloud_sync</span>
            Sync All
        </button>

        <button class="fab small" onclick="saveAllAttendance()" aria-label="Save" title="Save All">
            <span class="material-symbols-outlined fab-icon">save</span>
        </button>
    </div>

    <!-- iOS Toast Container -->
    <div id="iosToastContainer" class="ios-toast-container"></div>

    <!-- iOS Loading Overlay (hidden by default) -->
    <div id="iosLoadingOverlay" class="ios-loading-overlay" style="display:none;">
        <div class="ios-loading-box">
            <div class="ios-spinner"></div>
            <div class="ios-loading-text" id="iosLoadingText">Processing...</div>
        </div>
    </div>

    <div id="messageArea"></div>

    <!-- Add Student Modal -->
    <div id="addStudentModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
        <div
            style="background:var(--md-sys-color-surface); border-radius:24px; padding:24px; width:90%; max-width:400px; box-shadow:0 8px 32px rgba(0,0,0,0.2);">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
                <span class="material-symbols-outlined"
                    style="color:var(--md-sys-color-primary); font-size:28px;">person_add</span>
                <h2 style="margin:0; font-size:20px; color:var(--md-sys-color-on-surface);">Add New Student</h2>
            </div>

            <div style="display:flex; flex-direction:column; gap:12px;">
                <input type="text" id="newStudentName" placeholder="Full Name *"
                    style="padding:14px 16px; border-radius:12px; border:1px solid var(--md-sys-color-outline); background:transparent; color:var(--md-sys-color-on-surface); font-size:16px;">
                <input type="text" id="newStudentAppNumber" placeholder="Application Number"
                    style="padding:14px 16px; border-radius:12px; border:1px solid var(--md-sys-color-outline); background:transparent; color:var(--md-sys-color-on-surface); font-size:16px;">
                <input type="text" id="newStudentAppId" placeholder="Application ID"
                    style="padding:14px 16px; border-radius:12px; border:1px solid var(--md-sys-color-outline); background:transparent; color:var(--md-sys-color-on-surface); font-size:16px;">
                <input type="text" id="newStudentHostelId" placeholder="Hostel ID"
                    style="padding:14px 16px; border-radius:12px; border:1px solid var(--md-sys-color-outline); background:transparent; color:var(--md-sys-color-on-surface); font-size:16px;">
                <input type="text" id="newStudentAllocation" placeholder="Hostel Allocation (Room/Block)"
                    style="padding:14px 16px; border-radius:12px; border:1px solid var(--md-sys-color-outline); background:transparent; color:var(--md-sys-color-on-surface); font-size:16px;">
            </div>

            <div id="addStudentError"
                style="color:var(--md-sys-color-error); font-size:14px; margin-top:12px; display:none;"></div>

            <div style="display:flex; gap:12px; margin-top:20px; justify-content:flex-end;">
                <button onclick="closeAddStudentModal()"
                    style="padding:12px 24px; border-radius:20px; border:none; background:transparent; color:var(--md-sys-color-primary); font-weight:500; font-size:14px; cursor:pointer;">
                    Cancel
                </button>
                <button onclick="saveNewStudent()"
                    style="padding:12px 24px; border-radius:20px; border:none; background:var(--md-sys-color-primary); color:var(--md-sys-color-on-primary); font-weight:500; font-size:14px; cursor:pointer;">
                    Add Student
                </button>
            </div>
        </div>
    </div>

    <!-- Sync Tracker Modal -->
    <div id="syncTrackerModal" class="sync-tracker-modal">
        <div class="sync-tracker-header">
            <button onclick="closeSyncTracker()" style="background:none; border:none; cursor:pointer; padding:8px;">
                <span class="material-symbols-outlined" style="color:var(--md-sys-color-primary);">arrow_back_ios</span>
            </button>
            <h2> Sync Tracker</h2>
        </div>
        <div class="sync-tracker-content">
            <!-- Date Range Pills -->
            <div class="date-range-pills" style="flex-wrap: wrap;">
                <button class="date-range-pill active" onclick="setTrackerRange(7)">7 Days</button>
                <button class="date-range-pill" onclick="setTrackerRange(30)">30 Days</button>
                <button class="date-range-pill" onclick="setTrackerRange(90)">3 Months</button>
                <button class="date-range-pill" onclick="setTrackerRange(180)">6 Months</button>
                <button class="date-range-pill" onclick="showCustomDatePicker()">Custom</button>
            </div>

            <!-- Custom Date Picker (hidden by default) -->
            <div id="customDatePicker"
                style="display:none; margin-bottom:16px; padding:12px; background:var(--md-sys-color-surface-variant); border-radius:12px;">
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label style="font-size:13px; color:var(--md-sys-color-on-surface-variant);">From:</label>
                    <input type="date" id="trackerStartDate"
                        style="padding:8px 12px; border-radius:8px; border:1px solid var(--md-sys-color-outline); background:var(--md-sys-color-surface); color:var(--md-sys-color-on-surface); font-size:14px;">
                    <label style="font-size:13px; color:var(--md-sys-color-on-surface-variant);">To:</label>
                    <input type="date" id="trackerEndDate"
                        style="padding:8px 12px; border-radius:8px; border:1px solid var(--md-sys-color-outline); background:var(--md-sys-color-surface); color:var(--md-sys-color-on-surface); font-size:14px;">
                    <button onclick="applyCustomDateRange()"
                        style="padding:8px 16px; border-radius:8px; border:none; background:var(--md-sys-color-primary); color:white; font-size:13px; font-weight:500; cursor:pointer;">Apply</button>
                </div>
            </div>

            <!-- Sync Status Grid -->
            <table class="sync-tracker-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th><br><span style="font-size:9px;">Yoga</span></th>
                        <th><br><span style="font-size:9px;">Mess Day</span></th>
                        <th><br><span style="font-size:9px;">Mess Night</span></th>
                        <th><br><span style="font-size:9px;">Night Shift</span></th>
                        <th><br><span style="font-size:9px;">All</span></th>
                    </tr>
                </thead>
                <tbody id="syncTrackerBody">
                    <!-- Rows will be generated by JS -->
                </tbody>
            </table>

            <!-- Summary Card -->
            <div class="sync-summary-card">
                <div class="sync-summary-title">
                    <span class="material-symbols-outlined" style="font-size:18px;">trending_up</span>
                    Weekly Summary
                </div>
                <div class="sync-progress-bar">
                    <div class="sync-progress-fill" id="syncProgressFill" style="width: 0%;"></div>
                </div>
                <div class="sync-summary-stats" id="syncSummaryStats">
                    0% Complete  0/0 Days Synced
                </div>
            </div>
        </div>
    </div>

    <!-- Student Dashboard Modal -->
    <div id="studentDashboardModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:3000; justify-content:center; align-items:center; padding:16px;">
        <div
            style="background:var(--md-sys-color-surface); border-radius:24px; padding:24px; width:100%; max-width:500px; max-height:90vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span class="material-symbols-outlined"
                        style="color:var(--md-sys-color-primary); font-size:28px;">analytics</span>
                    <div>
                        <h2 id="dashboardStudentName"
                            style="margin:0; font-size:18px; color:var(--md-sys-color-on-surface);"></h2>
                        <div id="dashboardCategory"
                            style="font-size:12px; color:var(--md-sys-color-on-surface-variant);"></div>
                    </div>
                </div>
                <button onclick="closeStudentDashboard()"
                    style="background:none; border:none; cursor:pointer; padding:8px;">
                    <span class="material-symbols-outlined"
                        style="color:var(--md-sys-color-on-surface-variant);">close</span>
                </button>
            </div>

            <!-- Summary Stats -->
            <div style="display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap;">
                <div
                    style="flex:1; min-width:80px; background:var(--color-present-container); padding:12px; border-radius:12px; text-align:center;">
                    <div style="font-size:24px; font-weight:700; color:var(--color-present);" id="dashPresent">0</div>
                    <div style="font-size:12px; color:var(--color-present);">Present</div>
                </div>
                <div
                    style="flex:1; min-width:80px; background:var(--color-absent-container); padding:12px; border-radius:12px; text-align:center;">
                    <div style="font-size:24px; font-weight:700; color:var(--color-absent);" id="dashAbsent">0</div>
                    <div style="font-size:12px; color:var(--color-absent);">Absent</div>
                </div>
                <div
                    style="flex:1; min-width:80px; background:var(--color-leave-container); padding:12px; border-radius:12px; text-align:center;">
                    <div style="font-size:24px; font-weight:700; color:#805600;" id="dashLeave">0</div>
                    <div style="font-size:12px; color:#805600;">Leave</div>
                </div>
            </div>

            <!-- Date Details Sections -->
            <div id="dashboardDateDetails"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script>
        // --- State & Config ---
        let students = [];
        let attendanceByCategory = {};
        let attendance = {};
        let currentCategory = 'Yoga';
        let csvData = [];
        let loadedFromSheets = {};
        let studentSearchQuery = '';
        let verifiedCategories = {};
        let syncedCategories = {}; // Track which date+category has been synced
        const CATEGORIES = ['Yoga', 'Mess Day', 'Mess Night', 'Night Shift'];
        const STORAGE_KEY = 'hostel_attendance_saved_v2';
        const SYNC_STATUS_KEY = 'hostel_sync_status_v1';
        const LAST_STATE_KEY = 'hostel_last_state_v1';
        let GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyLrD98LEE_PQtqySBKqrZLyKvqzM3nXCAEMyYmejkLqwexp6cUTmDlIljQEazc7_8i/exec';
        let autoSaveTimeout = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function () {
            initTheme();
            restoreLastState(); // Restore date and category from last session
            loadSyncStatus(); // Load which date+categories have been synced
            setTodayDate();
            document.getElementById('attendanceDate').addEventListener('change', handleDateChange);
            document.getElementById('studentSearch').addEventListener('input', function () {
                studentSearchQuery = (this.value || '').trim().toLowerCase();
                renderStudentList();
            });

            // Scroll effect
            window.addEventListener('scroll', () => {
                const pill = document.getElementById('searchPill');
                if (!pill) return;
                if (window.scrollY > 10) {
                    pill.classList.add('elevated');
                } else {
                    pill.classList.remove('elevated');
                }
            });

            // Save state before page unload (refresh/close)
            window.addEventListener('beforeunload', function () {
                saveCurrentState();
            });

            // Auto-fetch students from Google Sheets on load
            fetchStudentsFromSheet();
        });

        // --- iOS-Style Toast & Loading Functions ---
        function showIOSToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('iosToastContainer');
            if (!container) return;

            // Remove existing toast
            container.innerHTML = '';

            const icons = {
                success: 'check',
                error: 'close',
                warning: 'priority_high',
                info: 'info'
            };

            const toast = document.createElement('div');
            toast.className = `ios-toast ${type}`;
            toast.innerHTML = `
                <div class="ios-toast-icon">
                    <span class="material-symbols-outlined">${icons[type] || 'info'}</span>
                </div>
                <span>${message}</span>
            `;

            container.appendChild(toast);

            // Auto dismiss
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 250);
            }, duration);
        }

        function showIOSLoading(text = 'Processing...') {
            const overlay = document.getElementById('iosLoadingOverlay');
            const textEl = document.getElementById('iosLoadingText');
            if (overlay) {
                overlay.style.display = 'flex';
                overlay.classList.remove('hiding');
            }
            if (textEl) textEl.textContent = text;
        }

        function hideIOSLoading() {
            const overlay = document.getElementById('iosLoadingOverlay');
            if (overlay) {
                overlay.classList.add('hiding');
                setTimeout(() => {
                    overlay.style.display = 'none';
                    overlay.classList.remove('hiding');
                }, 200);
            }
        }

        // --- Sync Status Management ---
        function loadSyncStatus() {
            try {
                const saved = localStorage.getItem(SYNC_STATUS_KEY);
                if (saved) {
                    syncedCategories = JSON.parse(saved);
                }
            } catch (e) { syncedCategories = {}; }
        }

        function saveSyncStatus() {
            try {
                localStorage.setItem(SYNC_STATUS_KEY, JSON.stringify(syncedCategories));
            } catch (e) { /* ignore */ }
        }

        function isSynced(date, category) {
            const key = `${date}_${category}`;
            return syncedCategories[key] === true;
        }

        function markAsSynced(date, category) {
            const key = `${date}_${category}`;
            syncedCategories[key] = true;
            saveSyncStatus();
        }

        // --- State Persistence ---
        function saveCurrentState() {
            const date = document.getElementById('attendanceDate')?.value;
            try {
                // Save current attendance for all categories
                const store = getSavedStore();
                if (date) {
                    store[date] = store[date] || {};
                    CATEGORIES.forEach(cat => {
                        if (attendanceByCategory[cat] && Object.keys(attendanceByCategory[cat]).length > 0) {
                            store[date][cat] = { ...attendanceByCategory[cat] };
                        }
                    });
                    store[date].verified = verifiedCategories;
                    setSavedStore(store);
                }

                // Save last viewed date and category
                localStorage.setItem(LAST_STATE_KEY, JSON.stringify({
                    date: date,
                    category: currentCategory
                }));
            } catch (e) { /* ignore */ }
        }

        function restoreLastState() {
            try {
                const saved = localStorage.getItem(LAST_STATE_KEY);
                if (saved) {
                    const state = JSON.parse(saved);
                    // Restore category if needed
                    if (state.category && CATEGORIES.includes(state.category)) {
                        currentCategory = state.category;
                    }
                }
            } catch (e) { /* ignore */ }
        }

        // --- Theme Logic ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcon(next);
            closeDrawer();
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (!icon || !text) return;
            if (theme === 'dark') {
                icon.textContent = 'light_mode';
                text.textContent = 'Light Mode';
            } else {
                icon.textContent = 'dark_mode';
                text.textContent = 'Dark Mode';
            }
        }

        // --- Drawer Logic ---
        let scrollPosition = 0;

        function openDrawer() {
            const d = document.getElementById('navDrawer');
            const s = document.getElementById('drawerScrim');
            // Save scroll position and lock body
            scrollPosition = window.pageYOffset;
            document.body.style.top = `-${scrollPosition}px`;
            document.body.classList.add('drawer-open');
            if (d) d.classList.add('open');
            if (s) s.classList.add('open');
        }

        function closeDrawer() {
            const d = document.getElementById('navDrawer');
            const s = document.getElementById('drawerScrim');
            if (d) d.classList.remove('open');
            if (s) s.classList.remove('open');
            // Restore scroll position
            document.body.classList.remove('drawer-open');
            document.body.style.top = '';
            window.scrollTo(0, scrollPosition);
        }

        // --- Swipe Gesture to Open/Close Drawer ---
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let isSwiping = false;

        document.addEventListener('touchstart', function (e) {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
            isSwiping = true;
        }, { passive: true });

        document.addEventListener('touchend', function (e) {
            if (!isSwiping) return;
            touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            handleSwipeGesture(touchStartX, touchEndX, touchStartY, touchEndY);
            isSwiping = false;
        }, { passive: true });

        function handleSwipeGesture(startX, endX, startY, endY) {
            const diffX = endX - startX;
            const diffY = Math.abs(endY - startY);
            const minSwipeDistance = 80; // Minimum swipe distance

            // Only trigger if horizontal swipe is greater than vertical (not scrolling)
            if (Math.abs(diffX) > diffY && Math.abs(diffX) > minSwipeDistance) {
                const drawer = document.getElementById('navDrawer');
                const isDrawerOpen = drawer && drawer.classList.contains('open');

                // Swipe right to open (from left half of screen)
                if (diffX > 0 && startX < window.innerWidth / 2 && !isDrawerOpen) {
                    openDrawer();
                }
                // Swipe left to close
                else if (diffX < 0 && isDrawerOpen) {
                    closeDrawer();
                }
            }
        }

        // --- Core Logic ---
        function setTodayDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const dateStr = `${yyyy}-${mm}-${dd}`;
            const dateEl = document.getElementById('attendanceDate');
            if (dateEl) dateEl.value = dateStr;
            const hDate = document.getElementById('headerDate');
            if (hDate) hDate.textContent = new Date(dateStr).toDateString();
        }

        function handleDateChange() {
            const dateStr = document.getElementById('attendanceDate').value;
            if (!dateStr) return;

            const hDate = document.getElementById('headerDate');
            if (hDate) hDate.textContent = new Date(dateStr).toDateString();

            loadedFromSheets[dateStr] = loadedFromSheets[dateStr] || {};

            if (students.length > 0) {
                initializeAllCategoriesAttendance();
                applySavedAttendanceForDate(dateStr);
                loadVerificationState(dateStr);
                ensureCategoryAttendance(currentCategory);
                attendance = attendanceByCategory[currentCategory];
                loadAttendanceData().then(() => {
                    updateVerificationUI();
                    updateFetchButtonVisibility();
                });
            } else {
                renderStudentList();
                loadVerificationState(dateStr);
                updateFetchButtonVisibility();
            }
        }

        function switchCategory(newCategory) {
            currentCategory = newCategory;

            // Update Title
            const t = document.getElementById('headerTitle');
            if (t) t.textContent = newCategory;

            // Update Drawer Active State
            document.querySelectorAll('.drawer-item').forEach(el => {
                el.classList.remove('active');
                if (el.textContent.includes(newCategory) && !el.textContent.includes('Download') && !el.textContent.includes('Reset') && !el.textContent.includes('Mode')) {
                    el.classList.add('active');
                }
            });
            // Specific ID fallback
            const navId = `nav-${newCategory}`;
            const activeItem = document.getElementById(navId);
            if (activeItem) activeItem.classList.add('active');

            closeDrawer();

            ensureCategoryAttendance(currentCategory);
            attendance = attendanceByCategory[currentCategory];

            const date = document.getElementById('attendanceDate').value;
            if (date && students.length > 0) {
                loadedFromSheets[date] = loadedFromSheets[date] || {};
                if (!loadedFromSheets[date][currentCategory]) {
                    loadAttendanceData();
                }
            }

            renderStudentList();
            updateVerificationUI();
            updateFetchButtonVisibility();
        }

        // --- Fetch Button Logic ---
        function updateFetchButtonVisibility() {
            const container = document.getElementById('fetchButtonContainer');
            const categoryLabel = document.getElementById('fetchCategoryName');
            const statusText = document.getElementById('fetchStatusText');
            if (!container) return;

            const date = document.getElementById('attendanceDate').value;
            // Use local date format (YYYY-MM-DD) instead of UTC to avoid timezone issues
            const now = new Date();
            const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            // Show fetch button only for past dates
            if (date < today) {
                container.style.display = 'block';
                if (categoryLabel) categoryLabel.textContent = currentCategory;

                // Update status text
                if (statusText) {
                    if (isSynced(date, currentCategory)) {
                        statusText.textContent = ' Data already loaded from database';
                        statusText.style.color = 'var(--color-present)';
                    } else {
                        statusText.textContent = 'Click to fetch attendance records from database';
                        statusText.style.color = 'var(--md-sys-color-on-surface-variant)';
                    }
                }
            } else {
                container.style.display = 'none';
            }
        }

        // Fetch current section's data from database
        async function fetchCurrentSectionFromDB() {
            const date = document.getElementById('attendanceDate').value;
            const category = currentCategory;

            if (!date) {
                showMessage('Please select a date', 'error');
                return;
            }

            showIOSLoading(`Fetching ${category} data...`);

            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: "fetch_category_data",
                        date: date,
                        category: category
                    })
                });
                const json = await res.json();
                hideIOSLoading();

                if (json.result === 'success' && json.data && json.data.length > 1) {
                    // Parse and populate attendance
                    const rows = json.data;
                    const headers = rows[0];
                    const nameIdx = headers.indexOf('Full Name');
                    const statusIdx = headers.indexOf('Status');

                    if (nameIdx !== -1 && statusIdx !== -1) {
                        ensureCategoryAttendance(category);
                        let count = 0;
                        for (let i = 1; i < rows.length; i++) {
                            const name = rows[i][nameIdx];
                            const status = rows[i][statusIdx];
                            if (name && ['Present', 'Absent', 'Leave'].includes(status)) {
                                attendanceByCategory[category][name] = status;
                                count++;
                            }
                        }

                        if (!loadedFromSheets[date]) loadedFromSheets[date] = {};
                        loadedFromSheets[date][category] = true;
                        markAsSynced(date, category);

                        attendance = attendanceByCategory[currentCategory];
                        renderStudentList();
                        updateFetchButtonVisibility();
                        showMessage(`Fetched ${count} records for ${category}!`, 'success');
                    } else {
                        showMessage('Invalid data format from database', 'error');
                    }
                } else if (json.result === 'success') {
                    showMessage(`No ${category} data found for ${date}`, 'warning');
                } else {
                    showMessage(`Fetch Failed: ${json.error || 'Unknown error'}`, 'error');
                }
            } catch (e) {
                hideIOSLoading();
                showMessage(`Network Error: ${e.message}`, 'error');
            }
        }

        // --- Sync Tracker Logic (YouTube-Level Optimized) ---
        let trackerDaysRange = 7;

        // SyncCache with TTL for production-level caching
        const SyncCache = {
            data: {},
            ttl: 5 * 60 * 1000, // 5 minutes cache

            getKey(date, category) {
                return `${date}_${category}`;
            },

            get(date, category) {
                const key = this.getKey(date, category);
                const entry = this.data[key];
                if (!entry) return null;
                if (Date.now() - entry.timestamp > this.ttl) {
                    delete this.data[key];
                    return null;
                }
                return entry.value;
            },

            set(date, category, count) {
                const key = this.getKey(date, category);
                this.data[key] = {
                    value: count,
                    timestamp: Date.now()
                };
            },

            setBatch(statusData) {
                Object.keys(statusData).forEach(date => {
                    Object.keys(statusData[date]).forEach(category => {
                        this.set(date, category, statusData[date][category]);
                    });
                });
            },

            clear() {
                this.data = {};
            }
        };

        // Batch fetch sync status from database
        async function fetchSyncStatusFromDB(dates) {
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'get_sync_status',
                        dates: dates,
                        totalStudents: students.length
                    })
                });
                const json = await res.json();
                if (json.result === 'success') {
                    SyncCache.setBatch(json.data);
                    return json.data;
                }
            } catch (e) {
                console.error('Sync status fetch error:', e);
            }
            return null;
        }

        // Check if synced from cache or return null
        function getCachedSyncCount(date, category) {
            return SyncCache.get(date, category);
        }

        function openSyncTracker() {
            closeDrawer();
            const modal = document.getElementById('syncTrackerModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.remove('hiding');
                renderSyncTrackerGrid();
            }
        }

        function closeSyncTracker() {
            const modal = document.getElementById('syncTrackerModal');
            if (modal) {
                modal.classList.add('hiding');
                setTimeout(() => {
                    modal.style.display = 'none';
                    modal.classList.remove('hiding');
                }, 250);
            }
        }

        function setTrackerRange(days) {
            trackerDaysRange = days;
            // Update active pill
            document.querySelectorAll('.date-range-pill').forEach(pill => {
                pill.classList.remove('active');
                if (pill.textContent.includes(days)) {
                    pill.classList.add('active');
                }
            });
            // Hide custom date picker when preset is selected
            const customPicker = document.getElementById('customDatePicker');
            if (customPicker) customPicker.style.display = 'none';

            renderSyncTrackerGrid();
        }

        function showCustomDatePicker() {
            // Update active pill
            document.querySelectorAll('.date-range-pill').forEach(pill => {
                pill.classList.remove('active');
                if (pill.textContent === 'Custom') {
                    pill.classList.add('active');
                }
            });

            // Show custom date picker
            const customPicker = document.getElementById('customDatePicker');
            if (customPicker) {
                customPicker.style.display = 'block';

                // Set default dates (last 7 days)
                const now = new Date();
                const endDate = now.toISOString().split('T')[0];
                const startDate = new Date(now);
                startDate.setDate(startDate.getDate() - 7);

                document.getElementById('trackerEndDate').value = endDate;
                document.getElementById('trackerStartDate').value = startDate.toISOString().split('T')[0];
            }
        }

        function applyCustomDateRange() {
            const startDateInput = document.getElementById('trackerStartDate');
            const endDateInput = document.getElementById('trackerEndDate');

            if (!startDateInput.value || !endDateInput.value) {
                showMessage('Please select both dates', 'error');
                return;
            }

            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);

            if (startDate > endDate) {
                showMessage('Start date must be before end date', 'error');
                return;
            }

            // Calculate days between dates
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

            trackerDaysRange = diffDays;
            customStartDate = startDateInput.value;
            customEndDate = endDateInput.value;
            isCustomRange = true;

            renderSyncTrackerGridCustom(startDate, endDate);
        }

        let customStartDate = null;
        let customEndDate = null;
        let isCustomRange = false;

        async function renderSyncTrackerGrid() {
            const tbody = document.getElementById('syncTrackerBody');
            if (!tbody) return;

            // Show loading state
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--md-sys-color-on-surface-variant);">Loading from database...</td></tr>';

            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            // Build dates array for batch fetch
            const dates = [];
            for (let i = 0; i < trackerDaysRange; i++) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                dates.push(`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`);
            }

            // Batch fetch from database
            const dbStatus = await fetchSyncStatusFromDB(dates);
            const totalStudents = students.length;

            let html = '';
            let totalDays = 0;
            let completeDays = 0;

            for (let i = 0; i < trackerDaysRange; i++) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                const dateStr = dates[i];
                const displayDate = d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });

                const isToday = dateStr === todayStr;

                // Get counts from database
                const yogaCount = dbStatus?.[dateStr]?.['Yoga'] || 0;
                const messDayCount = dbStatus?.[dateStr]?.['Mess Day'] || 0;
                const messNightCount = dbStatus?.[dateStr]?.['Mess Night'] || 0;
                const nightShiftCount = dbStatus?.[dateStr]?.['Night Shift'] || 0;

                // Calculate sync status: full, partial, or none
                const yogaStatus = getSyncLevel(yogaCount, totalStudents);
                const messDayStatus = getSyncLevel(messDayCount, totalStudents);
                const messNightStatus = getSyncLevel(messNightCount, totalStudents);
                const nightShiftStatus = getSyncLevel(nightShiftCount, totalStudents);
                const allSynced = yogaStatus === 'full' && messDayStatus === 'full' && messNightStatus === 'full' && nightShiftStatus === 'full';

                // Count for summary (exclude today)
                if (!isToday) {
                    totalDays++;
                    if (allSynced) completeDays++;
                }

                html += `
                    <tr class="${isToday ? 'today' : ''}">
                        <td>${displayDate}${isToday ? ' <span style="font-size:10px;color:var(--md-sys-color-primary);">(Today)</span>' : ''}</td>
                        <td>${renderStatusDotDB(yogaStatus, yogaCount, totalStudents, isToday)}</td>
                        <td>${renderStatusDotDB(messDayStatus, messDayCount, totalStudents, isToday)}</td>
                        <td>${renderStatusDotDB(messNightStatus, messNightCount, totalStudents, isToday)}</td>
                        <td>${renderStatusDotDB(nightShiftStatus, nightShiftCount, totalStudents, isToday)}</td>
                        <td>${allSynced ? '<span class="status-dot complete"><span class="material-symbols-outlined" style="font-size:16px;">check</span></span>' : '<span class="status-dot not-synced"></span>'}</td>
                    </tr>
                `;
            }

            tbody.innerHTML = html;

            // Update summary
            const percentage = totalDays > 0 ? Math.round((completeDays / totalDays) * 100) : 0;
            const progressFill = document.getElementById('syncProgressFill');
            const summaryStats = document.getElementById('syncSummaryStats');

            if (progressFill) progressFill.style.width = `${percentage}%`;
            if (summaryStats) summaryStats.innerHTML = `<strong>${percentage}%</strong> Complete  <strong>${completeDays}/${totalDays}</strong> Days Fully Synced`;
        }

        // Get sync level: 'full' or 'none'
        // Note: If data exists, it's 'full' - we can't compare against current student count
        // because new students may have been added after historical dates were synced
        function getSyncLevel(count, total) {
            // If there's any data synced, mark as full (can't retroactively add new students)
            if (count > 0) return 'full';
            return 'none';
        }

        // Render status dot based on database count
        function renderStatusDotDB(status, count, total, isToday) {
            if (status === 'full') {
                return '<span class="status-dot synced"><span class="material-symbols-outlined" style="font-size:16px;">check</span></span>';
            } else if (status === 'partial') {
                return `<span class="status-dot" style="background:rgba(255,149,0,0.15);color:#FF9500;" title="${count}/${total}"><span class="material-symbols-outlined" style="font-size:16px;">remove</span></span>`;
            } else if (isToday) {
                return '<span class="status-dot not-synced" style="background:rgba(0,122,255,0.1);color:#007AFF;"></span>';
            } else {
                return '<span class="status-dot not-synced"></span>';
            }
        }

        function renderStatusDot(isSynced, isToday) {
            if (isSynced) {
                return '<span class="status-dot synced"><span class="material-symbols-outlined" style="font-size:16px;">check</span></span>';
            } else if (isToday) {
                return '<span class="status-dot not-synced" style="background:rgba(0,122,255,0.1);color:#007AFF;"></span>';
            } else {
                return '<span class="status-dot not-synced"></span>';
            }
        }

        // Render grid for custom date range
        function renderSyncTrackerGridCustom(startDate, endDate) {
            const tbody = document.getElementById('syncTrackerBody');
            if (!tbody) return;

            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            let html = '';
            let totalDays = 0;
            let completeDays = 0;

            // Iterate from end date to start date (newest first)
            const current = new Date(endDate);
            while (current >= startDate) {
                const dateStr = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')}`;
                const displayDate = current.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });

                const isToday = dateStr === todayStr;

                // Check sync status for each category
                const yogaSynced = isSynced(dateStr, 'Yoga');
                const messDaySynced = isSynced(dateStr, 'Mess Day');
                const messNightSynced = isSynced(dateStr, 'Mess Night');
                const nightShiftSynced = isSynced(dateStr, 'Night Shift');
                const allSynced = yogaSynced && messDaySynced && messNightSynced && nightShiftSynced;

                // Count for summary (exclude today)
                if (!isToday) {
                    totalDays++;
                    if (allSynced) completeDays++;
                }

                html += `
                    <tr class="${isToday ? 'today' : ''}">
                        <td>${displayDate}${isToday ? ' <span style="font-size:10px;color:var(--md-sys-color-primary);">(Today)</span>' : ''}</td>
                        <td>${renderStatusDot(yogaSynced, isToday)}</td>
                        <td>${renderStatusDot(messDaySynced, isToday)}</td>
                        <td>${renderStatusDot(messNightSynced, isToday)}</td>
                        <td>${renderStatusDot(nightShiftSynced, isToday)}</td>
                        <td>${allSynced ? '<span class="status-dot complete"><span class="material-symbols-outlined" style="font-size:16px;">check</span></span>' : '<span class="status-dot not-synced"></span>'}</td>
                    </tr>
                `;

                current.setDate(current.getDate() - 1);
            }

            tbody.innerHTML = html;

            // Update summary
            const percentage = totalDays > 0 ? Math.round((completeDays / totalDays) * 100) : 0;
            const progressFill = document.getElementById('syncProgressFill');
            const summaryStats = document.getElementById('syncSummaryStats');

            if (progressFill) progressFill.style.width = `${percentage}%`;
            if (summaryStats) summaryStats.innerHTML = `<strong>${percentage}%</strong> Complete  <strong>${completeDays}/${totalDays}</strong> Days Fully Synced`;

            showMessage('Custom range applied!', 'success');
        }

        // --- Fetch Students from Google Sheets (with caching) ---
        const STUDENTS_CACHE_KEY = 'hostel_students_cache_v1';

        async function fetchStudentsFromSheet() {
            // 1. First, try to load from cache for instant display
            const cached = loadStudentsFromCache();
            if (cached && cached.length > 0) {
                students = cached;
                initializeAllCategoriesAttendance();
                attendance = attendanceByCategory[currentCategory];
                renderStudentList();
                showMessage('Loading updates...', 'info');
            } else {
                showMessage('Loading students...', 'info');
            }

            // 2. Then fetch fresh data from server in background
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'get_students' })
                });
                const json = await res.json();

                if (json.result === 'success') {
                    const freshStudents = (json.students || []).map(s => ({
                        name: s.name,
                        appNumber: s.appNumber || '',
                        appId: s.appId || s.appNumber || 'N/A',
                        hostelId: s.hostelId || '',
                        allocation: s.allocation || ''
                    }));

                    // Save to cache for next time
                    saveStudentsToCache(freshStudents);

                    // Update only if data changed
                    if (JSON.stringify(freshStudents) !== JSON.stringify(students)) {
                        students = freshStudents;
                        if (students.length > 0) {
                            initializeAllCategoriesAttendance();
                            attendance = attendanceByCategory[currentCategory];
                            handleDateChange();
                        } else {
                            renderStudentList();
                        }
                    }

                    if (students.length > 0) {
                        showMessage(` ${students.length} students ready`, 'success');
                    } else {
                        showMessage('No students found. Add students to get started.', 'info');
                    }
                } else {
                    if (!cached || cached.length === 0) {
                        showMessage(`Error: ${json.error}`, 'error');
                        renderStudentList();
                    }
                }
            } catch (e) {
                if (!cached || cached.length === 0) {
                    showMessage(`Network Error: ${e.message}`, 'error');
                    renderStudentList();
                } else {
                    showMessage('Using cached data (offline)', 'info');
                }
            }
        }

        function saveStudentsToCache(studentsList) {
            try {
                localStorage.setItem(STUDENTS_CACHE_KEY, JSON.stringify({
                    timestamp: Date.now(),
                    students: studentsList
                }));
            } catch (e) { /* ignore storage errors */ }
        }

        function loadStudentsFromCache() {
            try {
                const cached = localStorage.getItem(STUDENTS_CACHE_KEY);
                if (cached) {
                    const data = JSON.parse(cached);
                    // Cache valid for 24 hours
                    if (data.timestamp && (Date.now() - data.timestamp) < 24 * 60 * 60 * 1000) {
                        return data.students || [];
                    }
                }
            } catch (e) { /* ignore parse errors */ }
            return null;
        }

        // --- Add Student Modal Functions ---
        function openAddStudentModal() {
            closeDrawer();
            const modal = document.getElementById('addStudentModal');
            if (modal) {
                modal.style.display = 'flex';
                // Clear previous values
                document.getElementById('newStudentName').value = '';
                document.getElementById('newStudentAppNumber').value = '';
                document.getElementById('newStudentAppId').value = '';
                document.getElementById('newStudentHostelId').value = '';
                document.getElementById('newStudentAllocation').value = '';
                document.getElementById('addStudentError').style.display = 'none';
            }
        }

        function closeAddStudentModal() {
            const modal = document.getElementById('addStudentModal');
            if (modal) modal.style.display = 'none';
        }

        async function saveNewStudent() {
            const name = document.getElementById('newStudentName').value.trim();
            const appNumber = document.getElementById('newStudentAppNumber').value.trim();
            const appId = document.getElementById('newStudentAppId').value.trim();
            const hostelId = document.getElementById('newStudentHostelId').value.trim();
            const allocation = document.getElementById('newStudentAllocation').value.trim();
            const errorDiv = document.getElementById('addStudentError');

            if (!name) {
                errorDiv.textContent = 'Student name is required';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';
            showMessage('Adding student...', 'info');

            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'add_student',
                        student: { name, appNumber, appId, hostelId, allocation }
                    })
                });
                const json = await res.json();

                if (json.result === 'success') {
                    closeAddStudentModal();
                    // Add to local cache immediately for faster next load with full data
                    const newStudent = {
                        name,
                        appNumber: appNumber || '',
                        appId: appId || appNumber || 'N/A',
                        hostelId: hostelId || '',
                        allocation: allocation || ''
                    };
                    students.push(newStudent);
                    saveStudentsToCache(students);
                    initializeAllCategoriesAttendance();
                    attendance = attendanceByCategory[currentCategory];
                    renderStudentList();
                    showMessage(' Student added successfully!', 'success');
                } else {
                    errorDiv.textContent = json.error || 'Failed to add student';
                    errorDiv.style.display = 'block';
                }
            } catch (e) {
                errorDiv.textContent = `Network Error: ${e.message}`;
                errorDiv.style.display = 'block';
            }
        }

        // --- Rendering ---
        function renderStudentList() {
            const listDiv = document.getElementById('studentList');
            listDiv.innerHTML = '';

            const countEl = document.getElementById('totalStudentsCount');
            if (countEl) countEl.textContent = `${students.length} total`;

            if (students.length === 0) {
                listDiv.innerHTML = `<div style="text-align:center; padding: 40px; color: var(--md-sys-color-outline);">
                <span class="material-symbols-outlined" style="font-size: 48px; display:block; margin-bottom:16px;">group</span>
                No students found.<br>Use "Add Student" from the menu to add students.
            </div>`;
                updateStats();
                return;
            }

            ensureCategoryAttendance(currentCategory);
            attendance = attendanceByCategory[currentCategory];

            const q = (studentSearchQuery || '').trim().toLowerCase();
            const filteredStudents = !q ? students : students.filter(s => {
                return (s.name || '').toLowerCase().includes(q) || (s.appId || '').toLowerCase().includes(q);
            });

            filteredStudents.forEach(student => {
                const status = attendance[student.name] || 'Present';
                const item = document.createElement('div');
                item.className = 'student-card';

                // Avatar Color
                const firstChar = student.name.charAt(0).toUpperCase();
                const colors = ['#007AFF', '#5856D6', '#AF52DE', '#FF2D55', '#FF9500', '#FFCC00', '#34C759', '#00C7BE', '#30B0C7', '#5AC8FA'];
                let colorIndex = 0;
                if (student.name.length > 0) {
                    colorIndex = (student.name.charCodeAt(0) + student.name.charCodeAt(Math.min(1, student.name.length - 1))) % colors.length;
                }
                const avatarColor = colors[colorIndex];

                // Single status icon based on current status
                let statusIcon, statusColor, statusBg;
                if (status === 'Present') {
                    statusIcon = 'check_circle';
                    statusColor = '#34C759';
                    statusBg = '#E3F9E8';
                } else if (status === 'Absent') {
                    statusIcon = 'cancel';
                    statusColor = '#FF3B30';
                    statusBg = '#FFE5E3';
                } else {
                    statusIcon = 'schedule';
                    statusColor = '#FF9500';
                    statusBg = '#FFF4E5';
                }

                item.innerHTML = `
                <div class="student-avatar" style="background-color: ${avatarColor}; color: white;">${firstChar}</div>
                <div class="student-info">
                    <div class="student-name">${student.name}</div>
                    <div class="student-id">${student.appId}</div>
                </div>
                <button class="status-icon-btn" onclick="cycleStatus('${student.name}')" 
                    style="width: 44px; height: 44px; border-radius: 22px; border: none; 
                    background: ${statusBg}; display: flex; align-items: center; justify-content: center; 
                    cursor: pointer; transition: transform 0.15s ease;">
                    <span class="material-symbols-outlined" style="font-size: 28px; color: ${statusColor}; font-variation-settings: 'FILL' 1;">${statusIcon}</span>
                </button>
            `;
                listDiv.appendChild(item);
            });

            updateStats();
        }

        // Cycle through Present  Absent  Leave  Present
        function cycleStatus(studentName) {
            const date = document.getElementById('attendanceDate').value;

            // Don't allow changes if this category is already synced
            if (isSynced(date, currentCategory)) {
                showMessage(`${currentCategory} is synced. Cannot modify.`, 'warning');
                return;
            }

            ensureCategoryAttendance(currentCategory);
            const currentStatus = attendanceByCategory[currentCategory][studentName] || 'Present';
            let newStatus;
            if (currentStatus === 'Present') newStatus = 'Absent';
            else if (currentStatus === 'Absent') newStatus = 'Leave';
            else newStatus = 'Present';

            attendanceByCategory[currentCategory][studentName] = newStatus;
            attendance = attendanceByCategory[currentCategory];
            renderStudentList();

            // Auto-save after status change
            autoSaveAttendance();
        }

        function updateStatus(studentName, status) {
            ensureCategoryAttendance(currentCategory);
            attendanceByCategory[currentCategory][studentName] = status;
            attendance = attendanceByCategory[currentCategory];
            renderStudentList();
        }

        function updateStats() {
            let p = 0, a = 0, l = 0;
            Object.values(attendance).forEach(s => {
                if (s === 'Present') p++;
                else if (s === 'Absent') a++;
                else if (s === 'Leave') l++;
            });
            const pEl = document.getElementById('presentCount'); if (pEl) pEl.textContent = p;
            const aEl = document.getElementById('absentCount'); if (aEl) aEl.textContent = a;
            const lEl = document.getElementById('leaveCount'); if (lEl) lEl.textContent = l;
        }

        // --- Verification Logic ---
        function toggleVerification() {
            if (!verifiedCategories) verifiedCategories = {};
            verifiedCategories[currentCategory] = !verifiedCategories[currentCategory];
            updateVerificationUI();
            saveVerificationState();
        }

        function updateVerificationUI() {
            const card = document.getElementById('verificationCard');
            const icon = document.getElementById('verifyIcon');
            const text = document.getElementById('verifyText');
            const check = document.getElementById('verifyCheckmark');

            if (!card) return;

            const isVerified = verifiedCategories[currentCategory];

            if (isVerified) {
                card.classList.add('verified');
                icon.textContent = 'verified';
                text.textContent = `${currentCategory} Verified`;
                check.style.opacity = '1';
            } else {
                card.classList.remove('verified');
                icon.textContent = 'check_circle_outline';
                text.textContent = `Mark ${currentCategory} as Verified`;
                check.style.opacity = '0';
            }

            // Update Nav Indicators
            CATEGORIES.forEach(c => {
                const ind = document.getElementById(`nav-indicator-${c}`);
                if (ind) {
                    ind.textContent = verifiedCategories[c] ? 'check_circle' : '';
                    if (verifiedCategories[c]) ind.style.color = 'var(--color-present)';
                }
            });
        }

        function saveVerificationState() {
            const date = document.getElementById('attendanceDate').value;
            if (!date) return;
            const store = getSavedStore();
            store[date] = store[date] || {};
            store[date].verified = verifiedCategories;
            setSavedStore(store);
        }

        function loadVerificationState(date) {
            const store = getSavedStore();
            verifiedCategories = (store[date] && store[date].verified) || {};
            CATEGORIES.forEach(c => {
                if (typeof verifiedCategories[c] === 'undefined') verifiedCategories[c] = false;
            });
            updateVerificationUI();
        }

        // --- Persistence & Helpers ---
        function safeParseJSON(s) { try { return JSON.parse(s); } catch (e) { return null; } }
        function getSavedStore() {
            const raw = localStorage.getItem(STORAGE_KEY);
            const parsed = safeParseJSON(raw);
            return parsed && typeof parsed === 'object' ? parsed : {};
        }
        function setSavedStore(s) { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

        function initializeAllCategoriesAttendance() {
            attendanceByCategory = {};
            loadedFromSheets = {};
            CATEGORIES.forEach(c => {
                attendanceByCategory[c] = {};
                students.forEach(s => attendanceByCategory[c][s.name] = 'Present');
            });
        }

        function ensureCategoryAttendance(cat) {
            if (!attendanceByCategory[cat]) attendanceByCategory[cat] = {};
            students.forEach(s => {
                if (!attendanceByCategory[cat][s.name]) attendanceByCategory[cat][s.name] = 'Present';
            });
        }

        function applySavedAttendanceForDate(date) {
            CATEGORIES.forEach(c => {
                const store = getSavedStore();
                const saved = store?.[date]?.[c];
                if (saved && typeof saved === 'object') {
                    ensureCategoryAttendance(c);
                    students.forEach(s => {
                        const v = saved[s.name];
                        if (['Present', 'Absent', 'Leave'].includes(v)) attendanceByCategory[c][s.name] = v;
                    });
                    if (!loadedFromSheets[date]) loadedFromSheets[date] = {};
                    loadedFromSheets[date][c] = true;
                }
            });
        }

        // --- CSV Parsing ---
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                for (let j = 0; j < headers.length; j++) {
                    row[headers[j]] = values[j] || '';
                }
                rows.push(row);
            }
            return rows;
        }

        function csvEscape(v) {
            v = String(v || '');
            if (/[\n\r",]/.test(v)) return `"${v.replace(/"/g, '""')}"`;
            return v;
        }

        // --- Actions: Save, Download, Sync ---
        function saveAttendance() {
            const date = document.getElementById('attendanceDate').value;
            if (!students.length) return showMessage('No data to save', 'error');
            try {
                ensureCategoryAttendance(currentCategory);
                const store = getSavedStore();
                store[date] = store[date] || {};
                store[date][currentCategory] = { ...attendanceByCategory[currentCategory] };
                store[date].verified = verifiedCategories;
                setSavedStore(store);
                showMessage(`Saved ${currentCategory} for ${date}`, 'success');
            } catch (e) { showMessage(e.message, 'error'); }
        }

        // Save ALL categories for current date
        function saveAllAttendance() {
            const date = document.getElementById('attendanceDate').value;
            if (!students.length) return showMessage('No data to save', 'error');
            try {
                const store = getSavedStore();
                store[date] = store[date] || {};
                CATEGORIES.forEach(cat => {
                    ensureCategoryAttendance(cat);
                    if (attendanceByCategory[cat] && Object.keys(attendanceByCategory[cat]).length > 0) {
                        store[date][cat] = { ...attendanceByCategory[cat] };
                    }
                });
                store[date].verified = verifiedCategories;
                setSavedStore(store);
                showMessage(`Saved all sections for ${date}`, 'success');
            } catch (e) { showMessage(e.message, 'error'); }
        }

        // Auto-save with debounce (called on status change)
        function autoSaveAttendance() {
            if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                const date = document.getElementById('attendanceDate').value;
                if (!date || !students.length) return;
                try {
                    const store = getSavedStore();
                    store[date] = store[date] || {};
                    store[date][currentCategory] = { ...attendanceByCategory[currentCategory] };
                    store[date].verified = verifiedCategories;
                    setSavedStore(store);
                } catch (e) { /* silent auto-save */ }
            }, 500);
        }

        async function loadAttendanceData() {
            const date = document.getElementById('attendanceDate').value;
            loadedFromSheets[date] = loadedFromSheets[date] || {};
            if (loadedFromSheets[date][currentCategory]) return renderStudentList();

            if (typeof GOOGLE_SCRIPT_URL === 'undefined') return renderStudentList();

            // Try to fetch from database for previous dates
            const today = new Date().toISOString().split('T')[0];
            if (date < today && !loadedFromSheets[date][currentCategory]) {
                await fetchAttendanceFromDatabase(date);
            }

            renderStudentList();
        }

        // Fetch attendance from Google Sheets for a specific date
        async function fetchAttendanceFromDatabase(date) {
            try {
                showIOSLoading('Loading from database...');
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "fetch_reports", date: date })
                });
                const json = await res.json();
                hideIOSLoading();

                if (json.result === 'success' && json.data) {
                    let foundData = false;
                    for (const [sheetName, rows] of Object.entries(json.data)) {
                        if (rows && rows.length > 1 && CATEGORIES.includes(sheetName)) {
                            // Parse and populate attendance
                            const headers = rows[0];
                            const nameIdx = headers.indexOf('Full Name');
                            const statusIdx = headers.indexOf('Status');

                            if (nameIdx !== -1 && statusIdx !== -1) {
                                ensureCategoryAttendance(sheetName);
                                for (let i = 1; i < rows.length; i++) {
                                    const name = rows[i][nameIdx];
                                    const status = rows[i][statusIdx];
                                    if (name && ['Present', 'Absent', 'Leave'].includes(status)) {
                                        attendanceByCategory[sheetName][name] = status;
                                    }
                                }
                                if (!loadedFromSheets[date]) loadedFromSheets[date] = {};
                                loadedFromSheets[date][sheetName] = true;
                                // Mark as synced since it came from database
                                markAsSynced(date, sheetName);
                                foundData = true;
                            }
                        }
                    }
                    if (foundData) {
                        attendance = attendanceByCategory[currentCategory];
                        showMessage('Loaded from database', 'success');
                    }
                }
            } catch (e) {
                hideIOSLoading();
                // Silent fail, use local data
            }
        }

        function downloadAttendance() {
            const date = document.getElementById('attendanceDate').value;
            if (!students.length) return showMessage('No data', 'error');

            const timeValueByCategory = {
                'Yoga': 'Morning',
                'Mess Day': 'Morning',
                'Mess Night': 'Night',
                'Night Shift': 'Night'
            };
            const timeValue = timeValueByCategory[currentCategory] || currentCategory;

            let csv = 'Full Name,Application: Application Number,Application: ID,Hostel Id,Hostel Allocation,Time,Status,Reason,Date\n';

            students.forEach(s => {
                const status = attendance[s.name] || 'Present';
                csv += `${csvEscape(s.name)},${csvEscape(s.appNumber || '')},${csvEscape(s.appId || '')},${csvEscape(s.hostelId || '')},${csvEscape(s.allocation || '')},${csvEscape(timeValue)},${csvEscape(status)},,${csvEscape(date)}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_${currentCategory}_${date}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showMessage('CSV Downloaded', 'success');
        }

        function downloadOverallAttendance() {
            const date = document.getElementById('attendanceDate').value;
            if (!students.length) return showMessage('No data', 'error');

            try {
                const timeValueByCategory = { 'Yoga': 'Morning', 'Mess Day': 'Morning', 'Mess Night': 'Night', 'Night Shift': 'Night' };
                const wb = XLSX.utils.book_new();

                CATEGORIES.forEach(cat => {
                    ensureCategoryAttendance(cat);
                    const catAtt = attendanceByCategory[cat];
                    const aoa = [['Full Name', 'Application: Application Number', 'Application: ID', 'Hostel Id', 'Hostel Allocation', 'Time', 'Status', 'Reason', 'Date']];

                    students.forEach(s => {
                        const status = catAtt[s.name] || 'Present';
                        aoa.push([
                            s.name,
                            s.appNumber || '',
                            s.appId || '',
                            s.hostelId || '',
                            s.allocation || '',
                            timeValueByCategory[cat] || cat,
                            status,
                            '',
                            date
                        ]);
                    });
                    const ws = XLSX.utils.aoa_to_sheet(aoa);
                    XLSX.utils.book_append_sheet(wb, ws, cat);
                });
                XLSX.writeFile(wb, `Overall_Attendance_${date}.xlsx`);
                showMessage('Overall Excel Downloaded', 'success');
            } catch (e) { showMessage(e.message, 'error'); }
        }

        // Sync CURRENT section only (Individual Sync)
        async function syncCurrentSection() {
            const date = document.getElementById('attendanceDate').value;
            const category = currentCategory;

            if (!students.length) return showMessage('No data to sync', 'error');

            // Check if already synced
            if (isSynced(date, category)) {
                showMessage(`${category} already synced for ${date}. Cannot re-sync.`, 'warning');
                return;
            }

            // Check if verified
            if (!verifiedCategories[category]) {
                showMessage(`Please verify ${category} first`, 'error');
                return;
            }

            showIOSLoading(`Syncing ${category}...`);

            const timeValueByCategory = {
                'Yoga': 'Morning',
                'Mess Day': 'Morning',
                'Mess Night': 'Night',
                'Night Shift': 'Night'
            };

            ensureCategoryAttendance(category);
            const catAtt = attendanceByCategory[category];
            const timeValue = timeValueByCategory[category] || category;

            const rows = [];
            students.forEach(s => {
                const status = catAtt[s.name] || 'Present';
                rows.push([
                    s.name,
                    s.appNumber || '',
                    s.appId || '',
                    s.hostelId || '',
                    s.allocation || '',
                    timeValue,
                    status,
                    '',
                    date
                ]);
            });

            const payload = {
                action: "sync_batched_multi_sheet",
                batches: { [category]: rows }
            };

            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                hideIOSLoading();

                if (json.result === 'success') {
                    markAsSynced(date, category);
                    showMessage(`${category} synced successfully! `, 'success');
                } else {
                    showMessage(`Sync Failed: ${json.error}`, 'error');
                }
            } catch (e) {
                hideIOSLoading();
                showMessage(`Network Error: ${e.message}`, 'error');
            }
        }

        // Sync ALL sections
        async function syncToGoogleSheet() {
            const date = document.getElementById('attendanceDate').value;
            if (!students.length) return showMessage('No data to sync', 'error');

            // Check which categories are already synced
            const alreadySynced = CATEGORIES.filter(c => isSynced(date, c));
            const notSynced = CATEGORIES.filter(c => !isSynced(date, c));

            if (alreadySynced.length === CATEGORIES.length) {
                showMessage('All sections already synced for this date!', 'warning');
                return;
            }

            // Check verification for non-synced categories
            const unverified = notSynced.filter(c => !verifiedCategories[c]);
            if (unverified.length > 0) {
                showMessage(`Verify first: ${unverified.join(', ')}`, 'error');
                return;
            }

            let confirmMsg = `Sync ${notSynced.join(', ')} for ${date}?`;
            if (alreadySynced.length > 0) {
                confirmMsg += `\n\n(${alreadySynced.join(', ')} already synced - will be skipped)`;
            }
            if (!confirm(confirmMsg)) return;

            showIOSLoading('Syncing all sections...');

            const timeValueByCategory = {
                'Yoga': 'Morning',
                'Mess Day': 'Morning',
                'Mess Night': 'Night',
                'Night Shift': 'Night'
            };

            // Prepare batches only for non-synced categories
            const batches = {};

            for (const cat of notSynced) {
                ensureCategoryAttendance(cat);
                const catAtt = attendanceByCategory[cat];
                const timeValue = timeValueByCategory[cat] || cat;

                const rows = [];
                students.forEach(s => {
                    const status = catAtt[s.name] || 'Present';
                    rows.push([
                        s.name,
                        s.appNumber || '',
                        s.appId || '',
                        s.hostelId || '',
                        s.allocation || '',
                        timeValue,
                        status,
                        '',
                        date
                    ]);
                });

                batches[cat] = rows;
            }

            const payload = {
                action: "sync_batched_multi_sheet",
                batches: batches
            };

            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                hideIOSLoading();

                if (json.result === 'success') {
                    // Mark all synced categories
                    notSynced.forEach(cat => markAsSynced(date, cat));
                    showMessage('Sync Completed! All sections locked ', 'success');
                } else {
                    showMessage(`Sync Failed: ${json.error}`, 'error');
                }
            } catch (e) {
                hideIOSLoading();
                showMessage(`Network Error: ${e.message}`, 'error');
            }
        }

        function resetAttendance() {
            const date = document.getElementById('attendanceDate').value;

            // Don't allow reset if synced
            if (isSynced(date, currentCategory)) {
                showMessage(`Cannot reset ${currentCategory} - already synced!`, 'error');
                return;
            }

            if (confirm('Reset current list to Present?')) {
                students.forEach(s => attendanceByCategory[currentCategory][s.name] = 'Present');
                attendance = attendanceByCategory[currentCategory];
                renderStudentList();
                showMessage('Reset Complete', 'info');
            }
        }

        // iOS-style showMessage (maps to iOS toast)
        function showMessage(msg, type) {
            showIOSToast(msg, type);
        }

        // --- Admin Panel Logic ---
        function openAdminLogin() {
            closeDrawer();
            const p = prompt("Enter Admin Password:");
            if (p === 'admin123') {
                showAdminPanel();
            } else if (p !== null) {
                alert("Incorrect Password");
            }
        }

        function showAdminPanel() {
            const main = document.querySelector('.main-content');
            main.innerHTML = `
                <!-- Admin Header -->
                <div class="admin-header">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <button onclick="location.reload()" style="background:rgba(255,255,255,0.2); border:none; border-radius:12px; width:40px; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                            <span class="material-symbols-outlined" style="color:white;">arrow_back</span>
                        </button>
                        <div>
                            <div class="admin-header-title">Admin Panel</div>
                            <div class="admin-header-subtitle">v6.0  Rankings & AI Insights</div>
                        </div>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="admin-tabs-new">
                    <button class="admin-tab-new active" id="tab-overview" onclick="switchAdminTabNew('overview')">
                        <span class="material-symbols-outlined">dashboard</span>
                        Overview
                    </button>
                    <button class="admin-tab-new" id="tab-rankings" onclick="switchAdminTabNew('rankings')">
                        <span class="material-symbols-outlined">leaderboard</span>
                        Rankings
                    </button>
                    <button class="admin-tab-new" id="tab-ai" onclick="switchAdminTabNew('ai')">
                        <span class="material-symbols-outlined">psychology</span>
                        AI Insights
                    </button>
                    <button class="admin-tab-new" id="tab-reports" onclick="switchAdminTabNew('reports')">
                        <span class="material-symbols-outlined">download</span>
                        Reports
                    </button>
                </div>

                <!-- Overview Section -->
                <div id="section-overview" class="admin-section active">
                    <div class="stats-cards-row">
                        <div class="stat-card">
                            <div class="stat-card-value" id="totalStudentsOverview">-</div>
                            <div class="stat-card-label" id="totalStudentsLabel"> Total Students</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-value" id="avgAttendanceOverview">-</div>
                            <div class="stat-card-label" id="avgAttendanceLabel"> Avg Attendance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-value score-excellent" id="sectionStudentsCount">-</div>
                            <div class="stat-card-label" id="sectionStudentsLabel"> Section Students</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-value score-danger" id="atRiskCount">-</div>
                            <div class="stat-card-label" id="atRiskLabel"> At Risk</div>
                        </div>
                    </div>
                    <div id="overviewContent" style="margin-top:16px;">
                        <div class="empty-state">
                            <span class="material-symbols-outlined">sync</span>
                            <div>Loading data...</div>
                        </div>
                    </div>
                </div>

                <!-- Rankings Section -->
                <div id="section-rankings" class="admin-section">
                    <div class="filter-pills" id="rankingFilters">
                        <button class="filter-pill active" onclick="filterRankings('All')">All</button>
                        <button class="filter-pill" onclick="filterRankings('Yoga')"> Yoga</button>
                        <button class="filter-pill" onclick="filterRankings('Night Shift')"> Night Shift</button>
                        <button class="filter-pill" onclick="filterRankings('Mess Day')"> Mess Day</button>
                        <button class="filter-pill" onclick="filterRankings('Mess Night')"> Mess Night</button>
                    </div>
                    <div id="rankingsContent">
                        <div class="empty-state">
                            <span class="material-symbols-outlined">leaderboard</span>
                            <div>Loading rankings...</div>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Section -->
                <div id="section-ai" class="admin-section">
                    <div style="margin-bottom:16px;">
                        <h3 style="margin:0 0 4px 0; font-size:18px; color:var(--md-sys-color-on-surface);"> AI Attendance Analysis</h3>
                        <p style="margin:0; font-size:13px; color:var(--md-sys-color-on-surface-variant);">Select section to view AI insights</p>
                    </div>
                    <div class="filter-pills" id="aiFilters">
                        <button class="filter-pill active" onclick="filterAIInsights('All')">All</button>
                        <button class="filter-pill" onclick="filterAIInsights('Yoga')"> Yoga</button>
                        <button class="filter-pill" onclick="filterAIInsights('Night Shift')"> Night Shift</button>
                        <button class="filter-pill" onclick="filterAIInsights('Mess Day')"> Mess Day</button>
                        <button class="filter-pill" onclick="filterAIInsights('Mess Night')"> Mess Night</button>
                    </div>
                    <div id="aiContent">
                        <div class="empty-state">
                            <span class="material-symbols-outlined">psychology</span>
                            <div>Analyzing patterns...</div>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="section-reports" class="admin-section">
                    <div class="stat-card" style="margin-bottom:16px;">
                        <h3 style="margin:0 0 12px 0; font-size:16px; color:var(--md-sys-color-primary);"> Section-wise Report Download</h3>
                        
                        <!-- Section Filter -->
                        <div style="margin-bottom:16px;">
                            <label style="font-size:12px; color:var(--md-sys-color-primary); font-weight:500;">Select Section</label>
                            <select id="reportSection" class="date-input" style="width:100%; margin-top:8px;">
                                <option value="All">All Sections</option>
                                <option value="Yoga"> Yoga</option>
                                <option value="Mess Day"> Mess Day</option>
                                <option value="Mess Night"> Mess Night</option>
                                <option value="Night Shift"> Night Shift</option>
                            </select>
                        </div>

                        <!-- Period Selector -->
                        <div style="margin-bottom:16px;">
                            <label style="font-size:12px; color:var(--md-sys-color-primary); font-weight:500;">Select Period</label>
                            <select id="reportPeriod" class="date-input" style="width:100%; margin-top:8px;" onchange="toggleReportPeriod()">
                                <option value="month">By Month</option>
                                <option value="custom">Custom Date Range</option>
                            </select>
                        </div>

                        <!-- Month Selector (shown when By Month) -->
                        <div id="monthSelector" style="margin-bottom:16px;">
                            <label style="font-size:12px; color:var(--md-sys-color-primary); font-weight:500;">Select Month</label>
                            <input type="month" id="reportMonth" class="date-input" style="width:100%; margin-top:8px;">
                        </div>

                        <!-- Custom Date Range (hidden by default) -->
                        <div id="customDateRange" style="display:none; margin-bottom:16px;">
                            <div style="display:flex; gap:8px;">
                                <div style="flex:1;">
                                    <label style="font-size:12px; color:gray;">From</label>
                                    <input type="date" id="reportStartDate" class="date-input" style="width:100%; margin-top:4px;">
                                </div>
                                <div style="flex:1;">
                                    <label style="font-size:12px; color:gray;">To</label>
                                    <input type="date" id="reportEndDate" class="date-input" style="width:100%; margin-top:4px;">
                                </div>
                            </div>
                        </div>

                        <!-- Export Buttons -->
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <button onclick="downloadSectionReport('excel')" class="fab" style="flex:1; justify-content:center; position:static; margin:0;">
                                <span class="material-symbols-outlined">description</span> Excel
                            </button>
                            <button onclick="downloadSectionReport('pdf')" class="fab" style="flex:1; justify-content:center; position:static; margin:0; background:var(--md-sys-color-tertiary);">
                                <span class="material-symbols-outlined">picture_as_pdf</span> PDF
                            </button>
                        </div>
                        <div id="reportMsg" style="margin-top:12px; font-weight:500;"></div>
                    </div>

                    <div class="stat-card">
                        <h3 style="margin:0 0 12px 0; font-size:16px; color:var(--md-sys-color-primary);"> Quick Daily Report</h3>
                        <div class="date-input-container" style="margin-bottom:12px;">
                            <span class="material-symbols-outlined date-input-icon">calendar_today</span>
                            <input type="date" id="reportDate" class="date-input">
                        </div>
                        <button class="fab" onclick="fetchAndDownloadReport()" style="width:100%; justify-content:center; position:static; margin:0;">
                            <span class="material-symbols-outlined">cloud_download</span> Download
                        </button>
                        <div id="adminMsg" style="margin-top:12px; font-weight:500;"></div>
                    </div>
                </div>
            `;

            // Set today's date and current month
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = today.substring(0, 7); // YYYY-MM format
            document.getElementById('reportDate').value = today;
            document.getElementById('reportMonth').value = currentMonth;

            // Load tracking data and render overview
            loadAdminData();
        }

        // New Tab Switching for Admin v6.0
        function switchAdminTabNew(tab) {
            document.querySelectorAll('.admin-tab-new').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`section-${tab}`).classList.add('active');
        }

        // Load all admin data
        async function loadAdminData() {
            if (!window.trackingDataCache) {
                await fetchTrackingDataForAdmin();
            } else {
                renderAdminOverview();
                renderRankings();
                renderAIInsights();
            }
        }

        async function fetchTrackingDataForAdmin() {
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "get_tracking_data" })
                });
                const json = await res.json();
                if (json.result === 'success') {
                    window.trackingDataCache = json.data;
                    renderAdminOverview();
                    renderRankings();
                    renderAIInsights();
                }
            } catch (e) {
                console.error('Failed to fetch tracking data:', e);
            }
        }

        // Calculate student scores
        function calculateStudentScores() {
            if (!window.trackingDataCache) return [];

            return window.trackingDataCache.map(item => {
                const total = item.total || 0;
                const present = item.present || 0;
                const score = total > 0 ? Math.round((present / total) * 100) : 0;

                let tier = 'normal';
                if (score >= 90) tier = 'gold';
                else if (score >= 75) tier = 'silver';
                else if (score >= 50) tier = 'bronze';
                else tier = 'at-risk';

                return { ...item, score, tier };
            }).sort((a, b) => b.score - a.score);
        }

        // Render Overview
        function renderAdminOverview() {
            // Build content with section filter first
            const container = document.getElementById('overviewContent');

            let html = `
                <div style="margin-bottom:16px;">
                    <label style="font-size:12px; color:var(--md-sys-color-primary); font-weight:500;">Select Section</label>
                    <select id="overviewSection" class="date-input" style="width:100%; margin-top:8px;" onchange="updateOverviewStats()">
                        <option value="All">All Sections</option>
                        <option value="Yoga"> Yoga</option>
                        <option value="Mess Day"> Mess Day</option>
                        <option value="Mess Night"> Mess Night</option>
                        <option value="Night Shift"> Night Shift</option>
                    </select>
                </div>
                <div id="overviewTop5Container"></div>
            `;
            container.innerHTML = html;

            // Render stats for default selection (All)
            updateOverviewStats();
        }

        // Update all stats based on section selection
        function updateOverviewStats() {
            const section = document.getElementById('overviewSection').value;
            const allScores = calculateStudentScores();

            // Filter by section
            let scores = section === 'All' ? allScores : allScores.filter(s => s.category === section);

            // Calculate stats for selected section
            const totalStudents = scores.length;
            const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b.score, 0) / scores.length) : 0;
            const sectionCount = scores.length;
            const atRisk = scores.filter(s => s.tier === 'at-risk').length;

            // Update stat cards
            document.getElementById('totalStudentsOverview').textContent = totalStudents;
            document.getElementById('avgAttendanceOverview').textContent = avgScore + '%';
            document.getElementById('sectionStudentsCount').textContent = sectionCount;
            document.getElementById('atRiskCount').textContent = atRisk;

            // Update labels
            const sectionLabel = section === 'All' ? 'All Sections' : section;
            document.getElementById('totalStudentsLabel').textContent = ` ${sectionLabel}`;
            document.getElementById('avgAttendanceLabel').textContent = ` Avg (${sectionLabel})`;
            document.getElementById('sectionStudentsLabel').textContent = ` ${sectionLabel}`;
            document.getElementById('atRiskLabel').textContent = ` At Risk (${sectionLabel})`;

            // Update Top 5
            const top5 = scores.slice(0, 5);
            const topContainer = document.getElementById('overviewTop5Container');

            let html = `<h4 style="margin:0 0 12px 0; font-size:14px; color:var(--md-sys-color-on-surface-variant);"> Top 5 ${sectionLabel}</h4>`;

            if (top5.length === 0) {
                html += '<div class="empty-state"><span class="material-symbols-outlined">search_off</span><div>No students in this section</div></div>';
            } else {
                top5.forEach((student, i) => {
                    const tierClass = student.tier;
                    const scoreClass = student.score >= 90 ? 'score-excellent' : student.score >= 75 ? 'score-good' : student.score >= 50 ? 'score-warning' : 'score-danger';
                    const originalIndex = allScores.findIndex(s => s.name === student.name && s.category === student.category);
                    const medal = i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : (i + 1);
                    html += `
                        <div class="ranking-card" onclick="openStudentDashboardFromRanking(${originalIndex})" style="cursor:pointer;">
                            <div class="ranking-position ${tierClass}">${medal}</div>
                            <div class="ranking-info">
                                <div class="ranking-name">${student.name}</div>
                                <div class="ranking-category">${student.category}  P:${student.present} A:${student.absent} L:${student.leave}</div>
                            </div>
                            <div class="ranking-score">
                                <div class="ranking-score-value ${scoreClass}">${student.score}%</div>
                                <div class="ranking-score-label">${student.present}/${student.total}</div>
                            </div>
                        </div>
                    `;
                });
            }

            topContainer.innerHTML = html;
        }

        // Render Rankings
        let currentRankingFilter = 'All';

        function filterRankings(category) {
            currentRankingFilter = category;
            document.querySelectorAll('#rankingFilters .filter-pill').forEach(p => {
                p.classList.toggle('active', p.textContent.includes(category) || (category === 'All' && p.textContent === 'All'));
            });
            renderRankings();
        }

        function renderRankings() {
            const scores = calculateStudentScores();
            const filtered = currentRankingFilter === 'All'
                ? scores
                : scores.filter(s => s.category === currentRankingFilter);

            const container = document.getElementById('rankingsContent');

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><span class="material-symbols-outlined">search_off</span><div>No data for this category</div></div>';
                return;
            }

            let html = '';
            filtered.forEach((student, i) => {
                const tierClass = student.tier;
                const scoreClass = student.score >= 90 ? 'score-excellent' : student.score >= 75 ? 'score-good' : student.score >= 50 ? 'score-warning' : 'score-danger';
                const medal = i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : (i + 1);

                // Find index in original scores array for the dashboard function
                const originalIndex = scores.findIndex(s => s.name === student.name && s.category === student.category);
                html += `
                    <div class="ranking-card" onclick="openStudentDashboardFromRanking(${originalIndex})" style="cursor:pointer;">
                        <div class="ranking-position ${tierClass}">${medal}</div>
                        <div class="ranking-info">
                            <div class="ranking-name">${student.name}</div>
                            <div class="ranking-category">${student.category}  P:${student.present} A:${student.absent} L:${student.leave}</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width:${student.score}%; background:${student.score >= 75 ? '#34C759' : student.score >= 50 ? '#FF9500' : '#FF3B30'};"></div>
                            </div>
                        </div>
                        <div class="ranking-score">
                            <div class="ranking-score-value ${scoreClass}">${student.score}%</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Render AI Insights
        function renderAIInsights() {
            const scores = calculateStudentScores();
            const container = document.getElementById('aiContent');

            // Categorize issues
            const criticalAbsent = scores.filter(s => s.score < 50 && s.total >= 5);
            const excessiveLeave = scores.filter(s => s.total > 0 && (s.leave / s.total) > 0.3);
            const perfectAttendance = scores.filter(s => s.score === 100 && s.total >= 5);

            let html = '';

            // Critical: Very low attendance
            if (criticalAbsent.length > 0) {
                const names = criticalAbsent.slice(0, 5).map(s => ` ${s.name} (${s.category}): ${s.score}%`).join('<br>');
                html += `
                    <div class="ai-card critical">
                        <div class="ai-card-header">
                            <div class="ai-card-icon"><span class="material-symbols-outlined">warning</span></div>
                            <div class="ai-card-title"> Critical: Low Attendance (${criticalAbsent.length} students)</div>
                        </div>
                        <div class="ai-card-students">${names}${criticalAbsent.length > 5 ? `<br>... and ${criticalAbsent.length - 5} more` : ''}</div>
                        <div class="ai-card-suggestion"> Recommendation: Schedule immediate counseling sessions with these students to understand their challenges.</div>
                    </div>
                `;
            }

            // Warning: Excessive leave
            if (excessiveLeave.length > 0) {
                const names = excessiveLeave.slice(0, 5).map(s => ` ${s.name}: ${s.leave} leaves (${Math.round(s.leave / s.total * 100)}%)`).join('<br>');
                html += `
                    <div class="ai-card warning">
                        <div class="ai-card-header">
                            <div class="ai-card-icon"><span class="material-symbols-outlined">event_busy</span></div>
                            <div class="ai-card-title"> Excessive Leave Pattern (${excessiveLeave.length} students)</div>
                        </div>
                        <div class="ai-card-students">${names}${excessiveLeave.length > 5 ? `<br>... and ${excessiveLeave.length - 5} more` : ''}</div>
                        <div class="ai-card-suggestion"> Recommendation: Review leave requests and verify if there are underlying health or personal issues.</div>
                    </div>
                `;
            }

            // Info: Perfect attendance (positive)
            if (perfectAttendance.length > 0) {
                const names = perfectAttendance.slice(0, 5).map(s => ` ${s.name} (${s.category})`).join('<br>');
                html += `
                    <div class="ai-card info">
                        <div class="ai-card-header">
                            <div class="ai-card-icon"><span class="material-symbols-outlined">stars</span></div>
                            <div class="ai-card-title"> Perfect Attendance (${perfectAttendance.length} students)</div>
                        </div>
                        <div class="ai-card-students">${names}${perfectAttendance.length > 5 ? `<br>... and ${perfectAttendance.length - 5} more` : ''}</div>
                        <div class="ai-card-suggestion"> Recommendation: Recognize and reward these students to encourage continued excellence!</div>
                    </div>
                `;
            }

            if (html === '') {
                html = '<div class="empty-state"><span class="material-symbols-outlined">check_circle</span><div>No issues detected! All students are maintaining good attendance.</div></div>';
            }

            container.innerHTML = html;
        }

        // AI Insights Filter
        let currentAIFilter = 'All';

        function filterAIInsights(category) {
            currentAIFilter = category;
            document.querySelectorAll('#aiFilters .filter-pill').forEach(p => {
                p.classList.toggle('active', p.textContent.includes(category) || (category === 'All' && p.textContent === 'All'));
            });
            renderAIInsightsFiltered();
        }

        function renderAIInsightsFiltered() {
            let scores = calculateStudentScores();
            const container = document.getElementById('aiContent');

            // Apply section filter
            if (currentAIFilter !== 'All') {
                scores = scores.filter(s => s.category === currentAIFilter);
            }

            // Categorize issues
            const criticalAbsent = scores.filter(s => s.score < 50 && s.total >= 5);
            const excessiveLeave = scores.filter(s => s.total > 0 && (s.leave / s.total) > 0.3);
            const perfectAttendance = scores.filter(s => s.score === 100 && s.total >= 5);

            let html = `<div style="margin-bottom:12px; font-size:13px; color:var(--md-sys-color-on-surface-variant);">Showing ${currentAIFilter === 'All' ? 'all sections' : currentAIFilter} (${scores.length} records)</div>`;

            if (criticalAbsent.length > 0) {
                const names = criticalAbsent.slice(0, 5).map(s => ` ${s.name}: ${s.score}%`).join('<br>');
                html += `
                    <div class="ai-card critical">
                        <div class="ai-card-header">
                            <div class="ai-card-icon"><span class="material-symbols-outlined">warning</span></div>
                            <div class="ai-card-title"> Critical: Low Attendance (${criticalAbsent.length})</div>
                        </div>
                        <div class="ai-card-students">${names}${criticalAbsent.length > 5 ? `<br>... and ${criticalAbsent.length - 5} more` : ''}</div>
                        <div class="ai-card-suggestion"> Schedule counseling sessions</div>
                    </div>
                `;
            }

            if (excessiveLeave.length > 0) {
                const names = excessiveLeave.slice(0, 5).map(s => ` ${s.name}: ${s.leave} leaves`).join('<br>');
                html += `
                    <div class="ai-card warning">
                        <div class="ai-card-header">
                            <div class="ai-card-icon"><span class="material-symbols-outlined">event_busy</span></div>
                            <div class="ai-card-title"> Excessive Leave (${excessiveLeave.length})</div>
                        </div>
                        <div class="ai-card-students">${names}${excessiveLeave.length > 5 ? `<br>... and ${excessiveLeave.length - 5} more` : ''}</div>
                        <div class="ai-card-suggestion"> Review leave patterns</div>
                    </div>
                `;
            }

            if (perfectAttendance.length > 0) {
                const names = perfectAttendance.slice(0, 5).map(s => ` ${s.name}`).join('<br>');
                html += `
                    <div class="ai-card info">
                        <div class="ai-card-header">
                            <div class="ai-card-icon"><span class="material-symbols-outlined">stars</span></div>
                            <div class="ai-card-title"> Perfect Attendance (${perfectAttendance.length})</div>
                        </div>
                        <div class="ai-card-students">${names}${perfectAttendance.length > 5 ? `<br>... and ${perfectAttendance.length - 5} more` : ''}</div>
                        <div class="ai-card-suggestion"> Reward these students!</div>
                    </div>
                `;
            }

            if (criticalAbsent.length === 0 && excessiveLeave.length === 0 && perfectAttendance.length === 0) {
                html += '<div class="empty-state"><span class="material-symbols-outlined">check_circle</span><div>No issues detected!</div></div>';
            }

            container.innerHTML = html;
        }

        // Toggle Period Selector
        function toggleReportPeriod() {
            const period = document.getElementById('reportPeriod').value;
            document.getElementById('monthSelector').style.display = period === 'month' ? 'block' : 'none';
            document.getElementById('customDateRange').style.display = period === 'custom' ? 'block' : 'none';
        }

        // Section-wise Report Download
        function downloadSectionReport(format) {
            if (!window.trackingDataCache || window.trackingDataCache.length === 0) {
                alert('No tracking data available. Please load data first.');
                return;
            }

            const section = document.getElementById('reportSection').value;
            const period = document.getElementById('reportPeriod').value;
            let startDate, endDate;

            if (period === 'month') {
                const monthVal = document.getElementById('reportMonth').value;
                if (!monthVal) {
                    alert('Please select a month');
                    return;
                }
                const [year, month] = monthVal.split('-');
                startDate = `${year}-${month}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                endDate = `${year}-${month}-${lastDay}`;
            } else {
                startDate = document.getElementById('reportStartDate').value;
                endDate = document.getElementById('reportEndDate').value;
                if (!startDate || !endDate) {
                    alert('Please select both start and end dates');
                    return;
                }
            }

            // Filter data
            let filteredData = window.trackingDataCache;

            // Filter by section
            if (section !== 'All') {
                filteredData = filteredData.filter(s => s.category === section);
            }

            if (filteredData.length === 0) {
                alert('No data found for selected filters');
                return;
            }

            const msgEl = document.getElementById('reportMsg');
            msgEl.textContent = 'Generating report...';
            msgEl.style.color = 'var(--md-sys-color-primary)';

            if (format === 'excel') {
                // Generate Excel
                const exportData = [
                    [`Section Report: ${section}`],
                    [`Period: ${startDate} to ${endDate}`],
                    [`Generated: ${new Date().toLocaleDateString()}`],
                    [],
                    ['Student Name', 'Category', 'Present', 'Absent', 'Leave', 'Total', 'Score %']
                ];

                filteredData.forEach(item => {
                    const score = item.total > 0 ? Math.round((item.present / item.total) * 100) : 0;
                    exportData.push([item.name, item.category, item.present, item.absent, item.leave, item.total, score]);
                });

                const ws = XLSX.utils.aoa_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, section === 'All' ? 'All Sections' : section);
                XLSX.writeFile(wb, `${section}_Report_${startDate}_to_${endDate}.xlsx`);

                msgEl.textContent = ' Excel downloaded!';
                msgEl.style.color = '#34C759';
            } else {
                // Generate PDF
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    doc.setFontSize(18);
                    doc.setTextColor(0, 122, 255);
                    doc.text(`${section} Report`, 14, 20);

                    doc.setFontSize(10);
                    doc.setTextColor(100);
                    doc.text(`Period: ${startDate} to ${endDate}`, 14, 30);
                    doc.text(`Total Students: ${filteredData.length}`, 14, 35);

                    const tableBody = filteredData.map(item => {
                        const score = item.total > 0 ? Math.round((item.present / item.total) * 100) : 0;
                        return [item.name, item.present, item.absent, item.leave, item.total, score + '%'];
                    });

                    doc.autoTable({
                        startY: 42,
                        head: [['Student', 'Present', 'Absent', 'Leave', 'Total', 'Score']],
                        body: tableBody,
                        theme: 'striped',
                        headStyles: { fillColor: [0, 122, 255] }
                    });

                    doc.save(`${section}_Report_${startDate}_to_${endDate}.pdf`);

                    msgEl.textContent = ' PDF downloaded!';
                    msgEl.style.color = '#34C759';
                } catch (e) {
                    msgEl.textContent = 'PDF Error: ' + e.message;
                    msgEl.style.color = '#FF3B30';
                }
            }
        }

        // Open Student Dashboard from Rankings
        function openStudentDashboardFromRanking(index) {
            const scores = calculateStudentScores();
            if (!scores || index < 0 || index >= scores.length) {
                console.error('Invalid student index:', index);
                return;
            }

            const student = scores[index];
            if (!student) {
                console.error('Student not found at index:', index);
                return;
            }

            // Get modal elements
            const modal = document.getElementById('studentDashboardModal');
            const nameEl = document.getElementById('dashboardStudentName');
            const categoryEl = document.getElementById('dashboardCategory');
            const presentEl = document.getElementById('dashPresent');
            const absentEl = document.getElementById('dashAbsent');
            const leaveEl = document.getElementById('dashLeave');
            const detailsEl = document.getElementById('dashboardDateDetails');

            if (!modal || !nameEl) {
                console.error('Modal elements not found. Modal:', modal, 'NameEl:', nameEl);
                alert('Dashboard modal not loaded. Please refresh the page.');
                return;
            }

            if (!detailsEl) {
                console.error('Details container not found. Looking for dashboardDateDetails');
                // Try to find it anyway
                const altDetailsEl = document.querySelector('#dashboardDateDetails, #dashboardDetails');
                if (!altDetailsEl) {
                    console.error('Could not find any details container');
                }
            }

            // Update modal header
            nameEl.textContent = student.name;
            categoryEl.textContent = student.category + '  Score: ' + student.score + '%';

            // Update summary counts
            presentEl.textContent = student.present || 0;
            absentEl.textContent = student.absent || 0;
            leaveEl.textContent = student.leave || 0;

            // Build date details HTML
            let detailsHtml = '';

            // Present dates
            if (student.presentDates && student.presentDates.length > 0) {
                detailsHtml += `<div style="margin-bottom:16px;">
                    <div style="font-weight:600; margin-bottom:8px; color:#34C759;"> Present Days (${student.presentDates.length})</div>
                    <div style="display:flex; flex-wrap:wrap; gap:6px;">
                        ${student.presentDates.slice(0, 10).map(d => `<span style="background:#d4edda; color:#155724; padding:6px 10px; border-radius:8px; font-size:13px;">${formatDateShort(d)}</span>`).join('')}
                        ${student.presentDates.length > 10 ? `<span style="color:gray;">+${student.presentDates.length - 10} more</span>` : ''}
                    </div>
                </div>`;
            }

            // Absent dates
            if (student.absentDates && student.absentDates.length > 0) {
                detailsHtml += `<div style="margin-bottom:16px;">
                    <div style="font-weight:600; margin-bottom:8px; color:#FF3B30;"> Absent Days (${student.absentDates.length})</div>
                    <div style="display:flex; flex-wrap:wrap; gap:6px;">
                        ${student.absentDates.slice(0, 10).map(d => `<span style="background:#f8d7da; color:#721c24; padding:6px 10px; border-radius:8px; font-size:13px;">${formatDateShort(d)}</span>`).join('')}
                        ${student.absentDates.length > 10 ? `<span style="color:gray;">+${student.absentDates.length - 10} more</span>` : ''}
                    </div>
                </div>`;
            }

            // Leave dates
            if (student.leaveDates && student.leaveDates.length > 0) {
                detailsHtml += `<div style="margin-bottom:16px;">
                    <div style="font-weight:600; margin-bottom:8px; color:#FF9500;"> Leave Days (${student.leaveDates.length})</div>
                    <div style="display:flex; flex-wrap:wrap; gap:6px;">
                        ${student.leaveDates.slice(0, 10).map(d => `<span style="background:#fff3cd; color:#856404; padding:6px 10px; border-radius:8px; font-size:13px;">${formatDateShort(d)}</span>`).join('')}
                        ${student.leaveDates.length > 10 ? `<span style="color:gray;">+${student.leaveDates.length - 10} more</span>` : ''}
                    </div>
                </div>`;
            }

            if (detailsHtml === '') {
                detailsHtml = '<div style="text-align:center; color:gray; padding:20px;">No date details available</div>';
            }

            if (detailsEl) {
                detailsEl.innerHTML = detailsHtml;
            }

            // Show modal
            modal.style.display = 'flex';
        }

        function formatDateShort(dateStr) {
            try {
                const date = new Date(dateStr);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${date.getDate()} ${months[date.getMonth()]}`;
            } catch (e) {
                return dateStr;
            }
        }

        function closeStudentDashboard() {
            document.getElementById('studentDashboardModal').style.display = 'none';
        }

        function downloadTrackingExcel() {
            // Debug Alert - To verify new code is loaded
            // alert("Starting Export V3 (clean columns)"); 

            if (!window.trackingDataCache) return alert("No data to export");

            // Get current filter values to export exactly what the user sees
            const query = document.getElementById('trackSearch').value.toLowerCase();
            const category = document.getElementById('trackCategory').value;
            const startDate = document.getElementById('trackStartDate').value || "All Time";
            const endDate = document.getElementById('trackEndDate').value || "Present";

            // Filter data based on current view
            const dataToExport = window.trackingDataCache.filter(item => {
                const matchesSearch = (item.name && item.name.toLowerCase().includes(query)) ||
                    (item.id && String(item.id).toLowerCase().includes(query));
                const matchesCat = category === 'All' || item.category === category;
                return matchesSearch && matchesCat;
            });

            if (dataToExport.length === 0) return alert("No data matches your filter to export");

            // Build Excel Content (Array of Arrays)
            const exportData = [
                ["Student Tracking Report"],
                ["Generated Date:", new Date().toLocaleDateString()],
                ["Period:", `From: ${startDate}  To: ${endDate}`],
                ["Category Filter:", category],
                [], // Spacer
                ["Student Name", "Category", "Present", "Absent", "Leave", "Total Days"] // Headers (REMOVED ID)
            ];

            dataToExport.forEach(item => {
                exportData.push([
                    item.name,
                    // item.id, // Removed ID as per user request
                    item.category,
                    item.present,
                    item.absent,
                    item.leave,
                    item.total
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(exportData);

            // Set column widths
            ws['!cols'] = [
                { wch: 30 }, // Name
                // { wch: 20 }, // ID (Removed)
                { wch: 15 }, // Category
                { wch: 10 }, // Present
                { wch: 10 }, // Absent
                { wch: 10 }, // Leave
                { wch: 12 }  // Total
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Tracking Data");

            // Filename with date range
            const filename = `Values_Report_${startDate}_to_${endDate}.xlsx`;
            XLSX.writeFile(wb, filename);
        }


        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            document.getElementById('admin-view-reports').style.display = tab === 'reports' ? 'block' : 'none';
            document.getElementById('admin-view-tracking').style.display = tab === 'tracking' ? 'block' : 'none';

            if (tab === 'tracking' && !window.trackingDataCache) {
                fetchTrackingData();
            }
        }

        // Tracking Cache Keys
        const TRACKING_CACHE_KEY = 'hostel_tracking_cache_v2';
        const TRACKING_CACHE_TIME_KEY = 'hostel_tracking_cache_time_v2';

        // Load from browser cache instantly
        function loadTrackingFromCache() {
            try {
                const cached = localStorage.getItem(TRACKING_CACHE_KEY);
                if (cached) {
                    return JSON.parse(cached);
                }
            } catch (e) { }
            return null;
        }

        // Save to browser cache
        function saveTrackingToCache(data) {
            try {
                localStorage.setItem(TRACKING_CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(TRACKING_CACHE_TIME_KEY, Date.now().toString());
            } catch (e) { }
        }

        // Get cache age in minutes
        function getTrackingCacheAge() {
            try {
                const time = localStorage.getItem(TRACKING_CACHE_TIME_KEY);
                if (time) {
                    const mins = Math.floor((Date.now() - parseInt(time)) / 60000);
                    return mins;
                }
            } catch (e) { }
            return null;
        }

        async function fetchTrackingData(startDate, endDate) {
            const loader = document.getElementById('trackingLoading');
            const content = document.getElementById('trackingContent');

            // If it's filtered fetch (dates provided), skip cache
            if (startDate || endDate) {
                loader.style.display = 'block';
                content.innerHTML = '';
                await fetchFreshTrackingData(startDate, endDate);
                return;
            }

            // STALE-WHILE-REVALIDATE: Show cached data instantly
            const cachedData = loadTrackingFromCache();
            const cacheAge = getTrackingCacheAge();

            if (cachedData && cachedData.length > 0) {
                window.trackingDataCache = cachedData;
                filterAndRenderTracking();

                // Show cache age indicator
                const ageText = cacheAge !== null ?
                    (cacheAge < 1 ? 'Just now' : `${cacheAge} min ago`) : '';
                if (ageText) {
                    const notice = document.createElement('div');
                    notice.id = 'cacheNotice';
                    notice.style.cssText = 'text-align:center; font-size:12px; color:gray; margin-bottom:8px;';
                    notice.innerHTML = ` Showing cached data (${ageText}) - <a href="#" onclick="forceFreshFetch(); return false;" style="color:var(--md-sys-color-primary);">Refresh</a>`;
                    content.insertBefore(notice, content.firstChild);
                }

                // Fetch fresh data in background (if cache > 5 mins old)
                if (cacheAge === null || cacheAge >= 5) {
                    fetchFreshTrackingData(startDate, endDate, true);
                }
            } else {
                // No cache, need to fetch
                loader.style.display = 'block';
                content.innerHTML = '';
                await fetchFreshTrackingData(startDate, endDate);
            }
        }

        async function fetchFreshTrackingData(startDate, endDate, isBackground = false) {
            const loader = document.getElementById('trackingLoading');
            const content = document.getElementById('trackingContent');

            if (!isBackground) {
                loader.style.display = 'block';
            }

            try {
                const payload = { action: "get_tracking_data" };
                if (startDate) payload.startDate = startDate;
                if (endDate) payload.endDate = endDate;

                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const json = await res.json();

                if (json.result === 'success') {
                    window.trackingDataCache = json.data;

                    // Save to cache (only if no date filter)
                    if (!startDate && !endDate) {
                        saveTrackingToCache(json.data);
                    }

                    // Remove cache notice if exists
                    const notice = document.getElementById('cacheNotice');
                    if (notice) notice.remove();

                    filterAndRenderTracking();

                    if (isBackground) {
                        showMessage(' Data updated', 'success');
                    }
                } else if (!isBackground) {
                    content.innerHTML = `<div style="color:red; text-align:center;">Error: ${json.error}</div>`;
                }
            } catch (e) {
                if (!isBackground) {
                    content.innerHTML = `<div style="color:red; text-align:center;">Network Error: ${e.message}</div>`;
                }
            } finally {
                loader.style.display = 'none';
            }
        }

        function forceFreshFetch() {
            const loader = document.getElementById('trackingLoading');
            loader.style.display = 'block';
            fetchFreshTrackingData(null, null);
        }

        async function refreshTrackingData() {
            const loader = document.getElementById('trackingLoading');
            const content = document.getElementById('trackingContent');
            loader.style.display = 'block';
            content.innerHTML = '<div style="text-align:center; color:var(--md-sys-color-primary);">Refreshing & storing data...</div>';

            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "refresh_tracking" })
                });
                const json = await res.json();

                if (json.result === 'success') {
                    window.trackingDataCache = json.data;
                    filterAndRenderTracking();
                    showMessage('Tracking data refreshed!', 'success');
                } else {
                    content.innerHTML = `<div style="color:red; text-align:center;">Error: ${json.error}</div>`;
                }
            } catch (e) {
                content.innerHTML = `<div style="color:red; text-align:center;">Network Error: ${e.message}</div>`;
            } finally {
                loader.style.display = 'none';
            }
        }

        function renderTrackingTable(data) {
            if (!data || data.length === 0) {
                document.getElementById('trackingContent').innerHTML = '<div style="text-align:center; padding:20px;">No records found.</div>';
                return;
            }

            let html = `
             <div class="tracking-table-container">
                <table class="tracking-table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Category</th>
                            <th>Present</th>
                            <th>Absent</th>
                            <th>Leave</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
             `;

            data.forEach((item, index) => {
                html += `
                    <tr>
                        <td>
                            <div style="font-weight:500; cursor:pointer;" onclick="showStudentDashboard(${index})">${item.name || 'Unknown'}</div>
                            <div style="font-size:12px; color:gray;">${item.category}</div>
                        </td>
                        <td>${item.category}</td>
                        <td><span class="badge present" style="cursor:pointer;" onclick="showStudentDashboard(${index}, 'present')">${item.present}</span></td>
                        <td><span class="badge absent" style="cursor:pointer;" onclick="showStudentDashboard(${index}, 'absent')">${item.absent}</span></td>
                        <td><span class="badge leave" style="cursor:pointer;" onclick="showStudentDashboard(${index}, 'leave')">${item.leave}</span></td>
                        <td><strong>${item.total}</strong></td>
                    </tr>
                 `;
            });

            html += `</tbody></table></div>`;
            document.getElementById('trackingContent').innerHTML = html;
        }

        // Apply date filter - fetches new data from backend
        function filterTrackingData() {
            const startDate = document.getElementById('trackStartDate')?.value || '';
            const endDate = document.getElementById('trackEndDate')?.value || '';

            // Fetch from backend with date filter
            fetchTrackingData(startDate, endDate);
        }

        // Apply local filters (search, category) without backend call
        function filterAndRenderTracking() {
            if (!window.trackingDataCache) return;

            const query = (document.getElementById('trackSearch')?.value || '').toLowerCase();
            const category = document.getElementById('trackCategory')?.value || 'All';

            const filtered = window.trackingDataCache.filter(item => {
                const matchesSearch = (item.name && item.name.toLowerCase().includes(query)) ||
                    (item.id && String(item.id).toLowerCase().includes(query));
                const matchesCat = category === 'All' || item.category === category;

                return matchesSearch && matchesCat;
            });

            renderTrackingTable(filtered);
        }

        // --- Student Dashboard Functions ---
        // Open student dashboard from rankings (uses calculated scores data)
        function openStudentDashboardFromRanking(index) {
            const scores = calculateStudentScores();
            if (!scores || index < 0 || index >= scores.length) {
                alert('Student data not found');
                return;
            }

            const student = scores[index];
            if (!student) return;

            // Update modal header
            document.getElementById('dashboardStudentName').textContent = student.name;
            document.getElementById('dashboardCategory').textContent = student.category;

            // Update summary counts
            document.getElementById('dashPresent').textContent = student.present || 0;
            document.getElementById('dashAbsent').textContent = student.absent || 0;
            document.getElementById('dashLeave').textContent = student.leave || 0;

            // Build date details HTML
            let detailsHtml = '';
            detailsHtml += buildDateSection(' Present Days', student.presentDates || [], 'present', false, student.present);
            detailsHtml += buildDateSection(' Absent Days', student.absentDates || [], 'absent', false, student.absent);
            detailsHtml += buildDateSection(' Leave Days', student.leaveDates || [], 'leave', false, student.leave);

            document.getElementById('dashboardDateDetails').innerHTML = detailsHtml;

            // Show modal
            document.getElementById('studentDashboardModal').style.display = 'flex';
        }

        function showStudentDashboard(index, focusType) {
            // Get data from filtered view
            const query = document.getElementById('trackSearch')?.value?.toLowerCase() || '';
            const category = document.getElementById('trackCategory')?.value || 'All';

            let dataSource = window.trackingDataCache || [];
            if (query || category !== 'All') {
                dataSource = dataSource.filter(item => {
                    const matchesSearch = (item.name && item.name.toLowerCase().includes(query)) ||
                        (item.id && String(item.id).toLowerCase().includes(query));
                    const matchesCat = category === 'All' || item.category === category;
                    return matchesSearch && matchesCat;
                });
            }

            const student = dataSource[index];
            if (!student) return;

            // Update modal header
            document.getElementById('dashboardStudentName').textContent = student.name;
            document.getElementById('dashboardCategory').textContent = student.category;

            // Update summary counts
            document.getElementById('dashPresent').textContent = student.present || 0;
            document.getElementById('dashAbsent').textContent = student.absent || 0;
            document.getElementById('dashLeave').textContent = student.leave || 0;

            // Build date details HTML
            let detailsHtml = '';

            // Present dates
            detailsHtml += buildDateSection(' Present Days', student.presentDates || [], 'present', focusType === 'present', student.present);

            // Absent dates
            detailsHtml += buildDateSection(' Absent Days', student.absentDates || [], 'absent', focusType === 'absent', student.absent);

            // Leave dates
            detailsHtml += buildDateSection(' Leave Days', student.leaveDates || [], 'leave', focusType === 'leave', student.leave);

            document.getElementById('dashboardDateDetails').innerHTML = detailsHtml;

            // Show modal
            const modal = document.getElementById('studentDashboardModal');
            modal.style.display = 'flex';
        }

        function buildDateSection(title, dates, type, isExpanded, count) {
            const colors = {
                present: { bg: 'var(--color-present-container)', text: 'var(--color-present)' },
                absent: { bg: 'var(--color-absent-container)', text: 'var(--color-absent)' },
                leave: { bg: 'var(--color-leave-container)', text: '#805600' }
            };
            const color = colors[type] || colors.present;
            const actualCount = count || (dates ? dates.length : 0);

            if (!dates || dates.length === 0) {
                // If count exists but no dates array (backend not updated)
                if (actualCount > 0) {
                    return `
                        <div style="margin-bottom:16px;">
                            <div style="font-weight:600; margin-bottom:8px; color:${color.text};">${title} (${actualCount})</div>
                            <div style="color:var(--md-sys-color-on-surface-variant); font-size:14px; padding:12px; background:var(--md-sys-color-surface-variant); border-radius:8px;">
                                 Please redeploy Code.gs to see date details
                            </div>
                        </div>
                    `;
                }
                return `
                    <div style="margin-bottom:16px;">
                        <div style="font-weight:600; margin-bottom:8px; color:${color.text};">${title} (0)</div>
                        <div style="color:var(--md-sys-color-on-surface-variant); font-size:14px; padding:12px; background:var(--md-sys-color-surface-variant); border-radius:8px;">No records</div>
                    </div>
                `;
            }

            const displayStyle = isExpanded ? '' : (dates.length > 6 ? 'max-height:120px; overflow-y:auto;' : '');

            let datesHtml = `<div style="display:flex; flex-wrap:wrap; gap:6px; ${displayStyle}">`;
            dates.forEach(dateStr => {
                const formattedDate = formatDateShort(dateStr);
                datesHtml += `<span style="background:${color.bg}; color:${color.text}; padding:6px 10px; border-radius:8px; font-size:13px; font-weight:500;">${formattedDate}</span>`;
            });
            datesHtml += '</div>';

            return `
                <div style="margin-bottom:16px;">
                    <div style="font-weight:600; margin-bottom:8px; color:${color.text};">${title} (${dates.length})</div>
                    ${datesHtml}
                </div>
            `;
        }

        function formatDateShort(dateStr) {
            try {
                const date = new Date(dateStr);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${months[date.getMonth()]} ${date.getDate()}`;
            } catch (e) {
                return dateStr;
            }
        }

        function closeStudentDashboard() {
            document.getElementById('studentDashboardModal').style.display = 'none';
        }

        async function fetchAndDownloadReport() {
            const date = document.getElementById('reportDate').value;
            if (!date) return;

            const msg = document.getElementById('adminMsg');
            msg.textContent = "Fetching from Google Sheet...";
            msg.style.color = "blue";

            try {
                // Use text/plain to avoid preflight options failure
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "fetch_reports", date: date })
                });
                const json = await res.json();

                if (json.result === 'success') {
                    msg.textContent = "Generating Excel...";
                    generateReportExcel(json.data, date);
                    msg.textContent = "Download Started!";
                    msg.style.color = "green";
                } else {
                    msg.textContent = "Error: " + json.error;
                    msg.style.color = "red";
                }
            } catch (e) {
                msg.textContent = "Network Error: " + e.message;
                msg.style.color = "red";
            }
        }

        function generateReportExcel(data, date) {
            const wb = XLSX.utils.book_new();
            let hasData = false;

            for (const [sheetName, rows] of Object.entries(data)) {
                if (rows && rows.length > 0) {
                    hasData = true;
                    const ws = XLSX.utils.aoa_to_sheet(rows);
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }
            }

            if (!hasData) {
                alert("No data found for this date.");
                return;
            }

            XLSX.writeFile(wb, `Attendance_Report_${date}.xlsx`);
        }



        function downloadTrackingPDF() {
            if (!window.trackingDataCache || window.trackingDataCache.length === 0) {
                return alert("No tracking data available. Please load data first.");
            }

            try {
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    return alert("PDF Library not loaded yet. Please wait a moment or reload the page.");
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Safe element access with fallbacks
                const searchEl = document.getElementById('trackSearch');
                const categoryEl = document.getElementById('trackCategory');
                const startDateEl = document.getElementById('trackStartDate');
                const endDateEl = document.getElementById('trackEndDate');

                const query = searchEl ? searchEl.value.toLowerCase() : '';
                const category = categoryEl ? categoryEl.value : 'All';
                const startDate = startDateEl ? (startDateEl.value || "All Time") : "All Time";
                const endDate = endDateEl ? (endDateEl.value || "Present") : "Present";

                // Filter data
                const dataToExport = window.trackingDataCache.filter(item => {
                    const matchesSearch = !query || (item.name && item.name.toLowerCase().includes(query)) ||
                        (item.id && String(item.id).toLowerCase().includes(query));
                    const matchesCat = category === 'All' || item.category === category;
                    return matchesSearch && matchesCat;
                });

                if (dataToExport.length === 0) {
                    return alert("No data to export.");
                }

                // Header Info
                doc.setFontSize(18);
                doc.setTextColor(0, 122, 255);
                doc.text("Student Tracking Report", 14, 20);

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
                doc.text(`Period: ${startDate} to ${endDate}`, 14, 35);
                doc.text(`Category: ${category}`, 14, 40);
                doc.text(`Total Students: ${dataToExport.length}`, 14, 45);

                // Table Data with scores
                const tableBody = dataToExport.map(item => {
                    const score = item.total > 0 ? Math.round((item.present / item.total) * 100) : 0;
                    return [
                        item.name,
                        item.category,
                        item.present,
                        item.absent,
                        item.leave,
                        item.total,
                        score + '%'
                    ];
                });

                doc.autoTable({
                    startY: 50,
                    head: [['Student Name', 'Category', 'Present', 'Absent', 'Leave', 'Total', 'Score']],
                    body: tableBody,
                    theme: 'striped',
                    headStyles: { fillColor: [0, 122, 255] },
                    styles: { fontSize: 8 },
                    columnStyles: {
                        0: { cellWidth: 45 },
                        1: { cellWidth: 25 },
                        6: { halign: 'center', fontStyle: 'bold' }
                    }
                });

                const filename = `Tracking_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);

                showMessage('PDF Downloaded!', 'success');
            } catch (e) {
                alert("PDF Error: " + e.message);
                console.error(e);
            }
        }

    </script>
</body>

</html>